/* Modu Engine - Built: 2026-01-20T08:39:51.638Z - Commit: f5de42b */
"use strict";var moduNetwork=(()=>{var V=Object.defineProperty,Se=Object.getOwnPropertyDescriptor,Ie=Object.getOwnPropertyNames,Te=Object.prototype.hasOwnProperty,Ue=(t,e)=>{for(var i in e)V(t,i,{get:e[i],enumerable:!0})},Ce=(t,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ie(e))!Te.call(t,r)&&r!==i&&V(t,r,{get:()=>e[r],enumerable:!(n=Se(e,r))||n.enumerable});return t},Ae=t=>Ce(V({},"__esModule",{value:!0}),t),re={};Ue(re,{connect:()=>X,decodeBinaryMessage:()=>le,encodeSyncHash:()=>ce,getRandomRoom:()=>ue,hashClientId:()=>W,listRooms:()=>he,modd:()=>ge,registerClientId:()=>P,unregisterClientId:()=>ae});var G="modd_auth_token",se="modd_auth_return_url",ve=class{constructor(){this.appId=null,this.centralServiceUrl="https://nodes.modd.io",this.debug=!1,this.initialized=!1,this.successCallbacks=[],this.errorCallbacks=[],this.stateChangeCallbacks=[],this.currentUser=null,this.pendingAuthCode=null,this.pendingAuthError=null,this.uiContainer=null,this.uiOptions=null,this.isModal=!1,this.isLoading=!1,this.loadingTimeout=null}init(t){if(this.appId=t.appId,this.debug=t.debug||!1,t.centralServiceUrl)this.centralServiceUrl=t.centralServiceUrl;else if(typeof window<"u"){const e=window.location.hostname;(e==="localhost"||e==="127.0.0.1")&&(this.centralServiceUrl="http://localhost:9001")}this.initialized=!0,this.log("Auth module initialized",{appId:this.appId,centralServiceUrl:this.centralServiceUrl}),this.processInitialAuth()}async processInitialAuth(){await this.handleAuthCallback(),await this.checkExistingSession()}onReady(t,e){this.initialized||this.init(t);const i=this.onAuthStateChange(n=>{n?(this.hideUI(),e(n),i()):this.showUI(t)});return i}showUI(t={}){if(this.ensureInitialized(),this.uiOptions={showGuest:!0,autoClose:!0,...t},this.ensureStyles(),this.uiOptions.container){const i=document.querySelector(this.uiOptions.container);if(!i)throw new Error(`Container ${this.uiOptions.container} not found`);this.uiContainer=i,this.isModal=!1}else{if(this.uiContainer){if(this.uiContainer.classList.contains("modu-auth-overlay"))return;this.hideUI()}this.uiContainer=document.createElement("div"),this.uiContainer.className="modu-auth-overlay",document.body.appendChild(this.uiContainer),this.isModal=!0}this.renderUI(),this.isLoading&&this.showLoading();const e=this.onAuthStateChange(i=>{if(i&&this.uiOptions?.autoClose){const n=this.uiOptions.onLogin;this.hideUI(),n&&n(i),e()}})}hideUI(){this.uiContainer&&(this.isModal&&this.uiContainer.parentNode?this.uiContainer.parentNode.removeChild(this.uiContainer):this.uiContainer.innerHTML="",this.uiContainer=null,this.uiOptions=null)}renderUI(){this.uiContainer&&(this.uiContainer.innerHTML=`
        <div class="modu-auth-card">
            <div class="modu-auth-header">
                <h2>Sign In</h2>
                <p>Play to save your progress</p>
            </div>
            
            <div class="modu-auth-buttons">
                <button class="modu-btn modu-btn-discord" data-provider="discord">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 4.164 4.164 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.118.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                    Continue with Discord
                </button>
                
                <button class="modu-btn modu-btn-google" data-provider="google">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10 5.35 0 9.25-3.67 9.25-9.09 0-1.15-.15-1.81-.15-1.81z"/></svg>
                    Continue with Google
                </button>
                
                ${this.uiOptions?.showGuest?`
        <div class="modu-auth-divider" >
          <span>or </span>
                </div>
                
                <button class="modu-btn modu-btn-guest" data-provider="guest">
                    Play as Guest
                </button>
                `:""}
            </div>
        </div>
    `,this.uiContainer.querySelectorAll("[data-provider]").forEach(t=>{t.addEventListener("click",e=>{const i=e.currentTarget.dataset.provider;i==="guest"?this.handleGuestLogin():this.login({provider:i})})}))}showLoading(){if(!this.uiContainer)return;const t=this.uiContainer.querySelector(".modu-auth-card");t&&(t.innerHTML=`
        <div class="modu-auth-header">
            <h2>Please wait</h2>
            <p>Authenticating your session...</p>
        </div>
        <div class="modu-spinner-container">
            <div class="modu-spinner"></div>
        </div>
      `),this.loadingTimeout&&clearTimeout(this.loadingTimeout),this.loadingTimeout=setTimeout(()=>{this.isLoading&&(this.log("Auth loading timed out"),this.isLoading=!1,this.renderUI())},1e4)}handleGuestLogin(){const t=`Guest_${Math.floor(Math.random()*9999)}`,e={id:"guest_"+Math.random().toString(36).slice(2,11),email:null,displayName:t,avatarUrl:null,provider:"guest"},i=this.uiOptions?.autoClose,n=this.uiOptions?.onGuest;n&&n(t),this.notifyStateChange(e),i&&this.hideUI()}ensureStyles(){if(typeof document>"u"||document.getElementById("modu-auth-styles"))return;const t=`
        .modu-auth-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 15, 30, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: system-ui, -apple-system, sans-serif;
            backdrop-filter: blur(8px);
        }

        .modu-auth-card {
            background: #1a1a2e;
            border: 1px solid #252545;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: moduFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes moduFadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modu-auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .modu-auth-header h2 {
            color: #fff;
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .modu-auth-header p {
            color: #8888aa;
            margin: 0;
            font-size: 16px;
        }

        .modu-auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .modu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modu-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .modu-btn:active {
            transform: translateY(0);
        }

        .modu-btn-discord {
            background: #5865F2;
            color: #fff;
        }

        .modu-btn-google {
            background: #fff;
            color: #1a1a2e;
        }

        .modu-btn-guest {
            background: #252545;
            color: #8888aa;
            border: 1px solid #333366;
        }
        
        .modu-btn-guest:hover {
            background: #333366;
            color: #fff;
        }

        .modu-auth-divider {
            display: flex;
            align-items: center;
            margin: 10px 0;
            color: #444466;
            font-size: 14px;
        }

        .modu-auth-divider::before,
        .modu-auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #252545;
        }

        .modu-auth-divider span {
            padding: 0 15px;
            text-transform: uppercase;
            font-weight: 600;
            font-size: 12px;
        }

        .modu-spinner-container {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        .modu-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(76, 201, 240, 0.1);
            border-radius: 50%;
            border-top-color: #4cc9f0;
            animation: modu-spin 1s ease-in-out infinite;
        }

        @keyframes modu-spin {
            to { transform: rotate(360deg); }
        }
    `,e=document.createElement("style");e.id="modu-auth-styles",e.textContent=t,document.head.appendChild(e)}login(t){this.ensureInitialized();const e=t?.provider,i=typeof window<"u"?window.location.href:"/";typeof localStorage<"u"&&localStorage.setItem(se,i);const n=new URLSearchParams({appId:this.appId,returnUrl:i});let r;e?r=`${this.centralServiceUrl}/auth/${e}?${n}`:r=`${this.centralServiceUrl}/auth/select?${n}`,this.log("Starting login flow",{provider:e,authUrl:r}),typeof window<"u"&&(window.location.href=r)}async logout(){this.ensureInitialized();const t=this.getStoredToken();if(t)try{await fetch(`${this.centralServiceUrl}/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${t}`}})}catch(e){this.log("Logout API call failed (continuing anyway)",e)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("User logged out")}async getUser(){if(this.ensureInitialized(),this.currentUser)return this.currentUser;const t=this.getStoredToken();if(!t)return null;try{const e=await fetch(`${this.centralServiceUrl}/auth/whoami`,{headers:{Authorization:`Bearer ${t}`}});if(!e.ok)return this.clearStoredToken(),null;const i=await e.json();return this.currentUser=i.user,this.currentUser}catch(e){return this.log("Failed to get user",e),null}}async deleteAccount(){this.ensureInitialized();const t=this.getStoredToken();if(!t)throw new Error("Not logged in");const e=await fetch(`${this.centralServiceUrl}/auth/account`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});if(!e.ok){const i=await e.json().catch(()=>({error:"Failed to delete account"}));throw new Error(i.error)}this.clearStoredToken(),this.currentUser=null,this.notifyStateChange(null),this.log("Account deleted")}onSuccess(t){if(this.successCallbacks.push(t),this.pendingAuthCode){const e=this.pendingAuthCode;this.pendingAuthCode=null,t(e)}return()=>{const e=this.successCallbacks.indexOf(t);e!==-1&&this.successCallbacks.splice(e,1)}}onError(t){if(this.errorCallbacks.push(t),this.pendingAuthError){const e=this.pendingAuthError;this.pendingAuthError=null,t(e)}return()=>{const e=this.errorCallbacks.indexOf(t);e!==-1&&this.errorCallbacks.splice(e,1)}}onAuthStateChange(t){return this.stateChangeCallbacks.push(t),t(this.currentUser),()=>{const e=this.stateChangeCallbacks.indexOf(t);e!==-1&&this.stateChangeCallbacks.splice(e,1)}}getToken(){return this.getStoredToken()}setToken(t){typeof localStorage<"u"&&localStorage.setItem(G,t),this.checkExistingSession()}ensureInitialized(){if(!this.initialized||!this.appId)throw new Error("Auth module not initialized. Call moddNetwork.auth.init() first.")}async handleAuthCallback(){if(typeof window>"u")return;const t=new URL(window.location.href),e=t.searchParams.get("code"),i=t.searchParams.get("error"),n=t.searchParams.get("error_description");(e||i)&&(this.isLoading=!0,this.uiContainer&&this.showLoading());try{if(i){this.log("Auth error received",{error:i,errorDescription:n}),t.searchParams.delete("error"),t.searchParams.delete("error_description"),window.history.replaceState({},"",t.toString()),this.pendingAuthError={code:i,message:n||i},this.errorCallbacks.forEach(r=>r(this.pendingAuthError));return}if(e){this.log("Auth code received",{code:e.substring(0,20)+"..."}),t.searchParams.delete("code"),window.history.replaceState({},"",t.toString());const r=await fetch(`${this.centralServiceUrl}/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(r.ok){const{token:u}=await r.json();u&&(typeof localStorage<"u"&&localStorage.setItem(G,u),this.log("Session token stored"),this.pendingAuthCode=e,this.successCallbacks.forEach(c=>c(e)))}else this.log("Failed to exchange auth code")}}catch(r){this.log("Error in handleAuthCallback:",r)}finally{this.isLoading=!1}}async checkExistingSession(){!!this.getStoredToken()&&!this.currentUser&&(this.isLoading=!0,this.uiContainer&&this.showLoading());const e=await this.getUser();this.isLoading=!1,this.notifyStateChange(e)}notifyStateChange(t){this.currentUser=t,this.stateChangeCallbacks.forEach(e=>e(t))}getStoredToken(){return typeof localStorage>"u"?null:localStorage.getItem(G)}clearStoredToken(){typeof localStorage<"u"&&(localStorage.removeItem(G),localStorage.removeItem(se))}log(...t){this.debug&&console.log("[modd-auth]",...t)}},ie=new ve;typeof window<"u"&&(window.moddAuth=ie);var A={TICK:1,INITIAL_STATE:2,ROOM_JOINED:3,ROOM_CREATED:4,ERROR:5,SNAPSHOT_UPDATE:6,ROOM_LEFT:7,SYNC_HASH:8,CLIENT_LIST_UPDATE:9,BINARY_INPUT:32,BINARY_SNAPSHOT:33,STATE_HASH:48,PARTITION_DATA:49};function W(t){let e=2166136261;for(let i=0;i<t.length;i++)e^=t.charCodeAt(i),e=Math.imul(e,16777619)>>>0;return e}var Q=new Map;function P(t){const e=W(t);Q.set(e,t)}function ae(t){const e=W(t);Q.delete(e)}function D(t){return Q.get(t)}function be(t){if(t.clientHash===void 0)return!1;const e=D(t.clientHash);return e&&t.clientId!==e?(t.clientId=e,!0):!1}function ce(t,e,i,n){const r=new TextEncoder().encode(t),u=new TextEncoder().encode(e),c=new Uint8Array(3+r.length+2+u.length+4+4),g=new DataView(c.buffer);let l=0;return c[l++]=A.SYNC_HASH,g.setUint16(l,r.length,!0),l+=2,c.set(r,l),l+=r.length,g.setUint16(l,u.length,!0),l+=2,c.set(u,l),l+=u.length,g.setUint32(l,i,!0),l+=4,g.setUint32(l,n,!0),c}function le(t){if(t.byteLength===0)return null;const e=new DataView(t),i=e.getUint8(0);try{switch(i){case A.TICK:{if(t.byteLength<5)return console.error("[modu-network] TICK message too short:",t.byteLength),null;const n=e.getUint32(1,!0);let r=[],u,c,g;if(t.byteLength>=14){u=e.getUint32(5,!0),g=e.getUint32(9,!0);const l=e.getUint8(13);let f=14;if(l>0&&f+l<=t.byteLength&&(c=new TextDecoder().decode(new Uint8Array(t,f,l)),f+=l),f>=t.byteLength)return{type:"TICK",frame:n,snapshotFrame:u,snapshotHash:c,majorityHash:g,inputs:r,events:r};const k=e.getUint8(f);f++;for(let E=0;E<k&&f+10<=t.byteLength;E++){const d=e.getUint32(f,!0);f+=4;const H=e.getUint32(f,!0);f+=4;const v=e.getUint16(f,!0);if(f+=2,f+v>t.byteLength)break;const U=new Uint8Array(t,f,v);f+=v;let o;const p=U[0];if(p===123||p===91)try{const O=new TextDecoder().decode(U);o=JSON.parse(O)}catch{o=U}else o=U;let b;typeof o=="object"&&!(o instanceof Uint8Array)?(o.clientId&&!D(d)&&P(o.clientId),b=o.clientId||D(d)||`hash_${d.toString(16)}`):b=D(d)||`hash_${d.toString(16)}`,r.push({seq:H,data:o,clientId:b,clientHash:d})}}return{type:"TICK",frame:n,snapshotFrame:u,snapshotHash:c,majorityHash:g,inputs:r,events:r}}case A.INITIAL_STATE:{let n=1;const r=e.getUint32(n,!0);n+=4;const u=e.getUint16(n,!0);if(n+=2,n+u>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE roomId"),null;const c=new TextDecoder().decode(new Uint8Array(t,n,u));n+=u;const g=e.getUint32(n,!0);if(n+=4,n+g>t.byteLength)return console.error("[modu-network] Buffer overflow reading INITIAL_STATE snapshot"),null;const l=new Uint8Array(t,n,g);n+=g;const f=e.getUint16(n,!0);n+=2;const k=[];for(let E=0;E<f&&n<t.byteLength;E++){const d=e.getUint32(n,!0);n+=4;const H=e.getUint32(n,!0);n+=4;const v=e.getUint32(n,!0);n+=4;const U=e.getUint16(n,!0);if(n+=2,n+U>t.byteLength)break;const o=new Uint8Array(t,n,U);n+=U;let p;const b=o[0];if(b===123||b===91)try{const M=new TextDecoder().decode(o);p=JSON.parse(M)}catch{p=o}else p=o;let O;typeof p=="object"&&!(p instanceof Uint8Array)?(p.clientId&&!D(d)&&P(p.clientId),O=p.clientId||D(d)||`hash_${d.toString(16)}`):O=D(d)||`hash_${d.toString(16)}`,k.push({seq:H,frame:v,data:p,clientId:O,clientHash:d})}return{type:"INITIAL_STATE",frame:r,snapshot:l,snapshotHash:"",inputs:k,events:k}}case A.ROOM_CREATED:{let n=1;const r=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const c=e.getUint16(n,!0);n+=2;const g=new TextDecoder().decode(new Uint8Array(t,n,c));n+=c;const l=e.getUint32(n,!0);n+=4;const f=new TextDecoder().decode(new Uint8Array(t,n,l)),{snapshot:k,snapshotHash:E}=JSON.parse(f);return{type:"ROOM_CREATED",roomId:u,clientId:g,snapshot:k,snapshotHash:E}}case A.ROOM_JOINED:{let n=1;const r=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const c=e.getUint16(n,!0);n+=2;const g=new TextDecoder().decode(new Uint8Array(t,n,c));return{type:"ROOM_JOINED",roomId:u,clientId:g}}case A.ERROR:{const n=e.getUint16(1,!0);return{type:"ERROR",message:new TextDecoder().decode(new Uint8Array(t,3,n))}}case A.SNAPSHOT_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const c=e.getUint32(n,!0);n+=4;const g=new TextDecoder().decode(new Uint8Array(t,n,c)),{snapshot:l,snapshotHash:f}=JSON.parse(g);return{type:"SNAPSHOT_UPDATE",roomId:u,snapshot:l,snapshotHash:f}}case A.ROOM_LEFT:{const n=e.getUint16(1,!0);return{type:"ROOM_LEFT",roomId:new TextDecoder().decode(new Uint8Array(t,3,n))}}case A.CLIENT_LIST_UPDATE:{let n=1;const r=e.getUint16(n,!0);n+=2;const u=new TextDecoder().decode(new Uint8Array(t,n,r));n+=r;const c=e.getUint32(n,!0);n+=4;const g=new TextDecoder().decode(new Uint8Array(t,n,c)),l=JSON.parse(g);return{type:"CLIENT_LIST_UPDATE",roomId:u,clients:l}}case A.BINARY_SNAPSHOT:return{type:"BINARY_SNAPSHOT",binaryData:new Uint8Array(t,1)};default:return null}}catch(n){return console.error("[modu-network] Decode error:",n),null}}async function ke(t){return t instanceof ArrayBuffer?t:typeof Blob<"u"&&t instanceof Blob?await t.arrayBuffer():new Uint8Array(t).buffer}async function X(t,e){const i=e.snapshot||{},n=e.user||null,r=e.onConnect||(()=>{}),u=e.onDisconnect||(()=>{}),c=e.onError||(x=>console.error("[modu-network]",x)),g=e.onMessage||(()=>{}),l=e.onTick||null,f=e.getStateHash||null,k=e.appId;if(!k)throw new Error("[modu-network] appId is required. Pass appId in connect options.");const E=e.centralServiceUrl||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io");console.log("[modu-network] Central service URL:",E);let d=!1,H=!1,v=new Set,U=[],o=null,p=null,b=null,O=e.fps||20,M=null,K=0,T=0,fe=0,pe=0,me=0,ye=0,Z=null,ee=null,z=0,te=0,J=0,F=null;function ne(x){for(const $ of x){const q=$.data||{},R=q.type||$.type;if(R==="join"||R==="reconnect"){const _=q.clientId||$.clientId;_&&P(_)}else if(R==="leave"){const _=q.clientId||$.clientId;_&&ae(_)}}}try{const x={};e.joinToken&&(x.joinToken=e.joinToken);const $=e.authToken||(typeof localStorage<"u"?localStorage.getItem("modd_auth_token"):null);if($&&!e.joinToken&&(x.authToken=$),e.nodeUrl){const B=e.nodeUrl.match(/:(\d+)/);B&&(x.preferredNodeId=`port_${B[1]}`),console.log("[modu-network] Requesting preferred node:",e.nodeUrl)}const q=`${E}/api/apps/${k}/rooms/${t}/connect`,R=await fetch(q,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!R.ok){const B=await R.json().catch(()=>({error:`HTTP ${R.status}`}));throw new Error(`Failed to get node assignment: ${B.error||R.statusText}`)}const _=await R.json();p=_.url,b=_.token,O=_.fps||20;const Ee=e.nodeUrl&&_.url===e.nodeUrl;console.log("[modu-network] Received Node URL:",p,"token:",b?"yes":"no","fps:",O,Ee?"(preferred)":"");const Oe=typeof globalThis<"u"&&globalThis.WebSocket?globalThis.WebSocket:WebSocket;return new Promise((B,oe)=>{M=B;const we=1e4,xe=setTimeout(()=>{if(!d){const a=`Connection timeout after ${we}ms - server did not respond with room state`;console.error(`[modu-network] ${a}`),o&&o.close(),oe(new Error(a))}},we),Y=()=>{clearTimeout(xe)},_e=b?`${p}?token=${encodeURIComponent(b)}`:p;o=new Oe(_e),o.binaryType="arraybuffer";const j={send(a){if(!d||!o||o.readyState!==1)return;if(a instanceof Uint8Array||a instanceof ArrayBuffer){const s=a instanceof Uint8Array?a:new Uint8Array(a),h=new Uint8Array(5+s.length),y=new DataView(h.buffer);h[0]=32,y.setUint32(1,J,!0),h.set(s,5),T+=h.length,o.send(h);return}const m=JSON.stringify({type:"SEND_INPUT",payload:{roomId:t,data:a}});T+=m.length,o.send(m)},sendSnapshot(a,m,s,h){if(!d||!o)return;if(a instanceof Uint8Array||a instanceof ArrayBuffer){const w=a instanceof Uint8Array?a:new Uint8Array(a),L=new TextEncoder().encode(m||""),I=new Uint8Array(10+L.length+w.length);I[0]=35;const S=new DataView(I.buffer);S.setUint32(1,s??0,!0),S.setUint32(5,h??0,!0),I[9]=L.length,I.set(L,10),I.set(w,10+L.length),T+=I.length,o.send(I);return}const y=JSON.stringify({type:"SEND_SNAPSHOT",payload:{roomId:t,snapshot:a,hash:m}});T+=y.length,o.send(y)},leaveRoom(){if(d&&o){const a=JSON.stringify({type:"LEAVE_ROOM",payload:{roomId:t}});T+=a.length,o.send(a)}o&&o.close()},getClients(){if(d&&o&&o.readyState===1){const a=JSON.stringify({type:"GET_CLIENTS",payload:{roomId:t}});T+=a.length,o.send(a)}},close(){o&&o.close()},get connected(){return d},get clientId(){return F},get node(){return p?p.match(/:(\d+)/)?.[1]||p:null},get bandwidthIn(){return me},get bandwidthOut(){return ye},get totalBytesIn(){return K},get totalBytesOut(){return T},get frame(){return J},getLatency(){return"0"},sendStateHash(a,m){if(!d||!o||o.readyState!==1)return;const s=new Uint8Array(9),h=new DataView(s.buffer);s[0]=A.STATE_HASH,h.setUint32(1,a,!0),h.setUint32(5,m>>>0,!0),T+=9,o.send(s)},sendPartitionData(a,m,s){if(!d||!o||o.readyState!==1)return;const h=new Uint8Array(8+s.length),y=new DataView(h.buffer);h[0]=A.PARTITION_DATA,y.setUint32(1,a,!0),h[5]=m,y.setUint16(6,s.length,!0),h.set(s,8),T+=h.length,o.send(h)},requestResync(){if(!d||!o||o.readyState!==1)return;const a=JSON.stringify({type:"REQUEST_RESYNC",payload:{roomId:t}});T+=a.length,o.send(a),console.log("[modu-network] Requested resync from server")},onReliabilityUpdate:void 0,onMajorityHash:void 0,onResyncSnapshot:void 0};o.onopen=()=>{Z=setInterval(()=>{me=K-fe,ye=T-pe,fe=K,pe=T},1e3),f&&(ee=setInterval(()=>{if(!(!d||!o||o.readyState!==1))try{const m=f();if(m){const s=ce(t,m,z,te);T+=s.byteLength,o.send(s)}}catch(m){console.warn("[modu-network] Error getting state hash:",m)}},1e3));const a=JSON.stringify({type:"JOIN_ROOM",payload:{roomId:t,user:n}});T+=a.length,o.send(a)},o.onerror=a=>{Y();const m=`Failed to connect to ${p}: ${a.message||"Unknown error"}`;c(m),d||oe(new Error(m))},o.onclose=()=>{Y(),d=!1,Z&&clearInterval(Z),ee&&clearInterval(ee),u()},o.onmessage=async a=>{let m;try{m=await ke(a.data)}catch(h){console.warn("[modu-network] Failed to read message data:",h);return}K+=m.byteLength;const s=le(m);if(s)switch(s.type){case"TICK":{if(!d){U.push(s);break}J=s.frame,te=s.frame;const h=s.inputs||s.events||[];if(h&&h.length>0){const w=Math.max(...h.map(L=>L.seq||0));w>z&&(z=w)}const y=h.filter(w=>!v.has(w.seq));y.forEach(w=>v.add(w.seq)),y.length>0&&ne(y),l&&l(s.frame,y,s.snapshotFrame,s.snapshotHash,s.majorityHash);break}case"ERROR":{if(s.message==="Room not found"){const h=JSON.stringify({type:"CREATE_ROOM",payload:{roomId:t,snapshot:i,user:n}});T+=h.length,o.send(h)}else Y(),c(s.message),oe(new Error(s.message));break}case"ROOM_CREATED":{d=!0,Y(),J=0,s.clientId&&(F=s.clientId,P(s.clientId),console.log(`[modu-network] Assigned clientId: ${s.clientId}`)),r(i,[],0,p,O,F),M&&M(j);break}case"INITIAL_STATE":{const h=H;console.log(`[modu-network] Received INITIAL_STATE, ${h?"RESYNC":"connecting"}...`);const{snapshot:y,frame:w,snapshotHash:L}=s;y&&L&&(y.snapshotHash=L);const I=s.inputs||s.events||[];if(J=w,te=w,I&&I.length>0){const S=Math.max(...I.map(C=>C.seq||0));S>z&&(z=S),I.forEach(C=>v.add(C.seq))}if(I&&I.length>0&&ne(I),h)if(j.onResyncSnapshot&&s.binaryData)console.log(`[modu-network] Calling onResyncSnapshot with ${s.binaryData.length} bytes, frame=${w}`),j.onResyncSnapshot(s.binaryData,w);else if(j.onResyncSnapshot&&y){const S=JSON.stringify({snapshot:y,snapshotHash:L}),N=new TextEncoder().encode(S);console.log(`[modu-network] Calling onResyncSnapshot with JSON snapshot (${N.length} bytes), frame=${w}`),j.onResyncSnapshot(N,w)}else console.warn("[modu-network] RESYNC received but no onResyncSnapshot callback registered!");else if(d=!0,H=!0,Y(),r(y,I||[],w,p,O,F),U.length>0){U.sort((S,C)=>S.frame-C.frame);for(const S of U){const C=(S.inputs||S.events||[]).filter(N=>!v.has(N.seq));C.forEach(N=>v.add(N.seq)),C.length>0&&ne(C);for(const N of C)be(N);l&&(C.length>0||S.frame>w)&&l(S.frame,C,S.snapshotFrame,S.snapshotHash,S.majorityHash)}U=[]}M&&M(j);break}case"ROOM_JOINED":{d=!0,s.clientId&&(F=s.clientId,P(s.clientId),console.log(`[modu-network] Assigned clientId: ${s.clientId}`));break}case"SNAPSHOT_UPDATE":{e.onSnapshot&&e.onSnapshot(s.snapshot,s.snapshotHash);break}case"BINARY_SNAPSHOT":{e.onBinarySnapshot&&e.onBinarySnapshot(s.binaryData);break}case"ROOM_LEFT":{console.log(`[modu-network] Left room ${s.roomId}`);break}case"CLIENT_LIST_UPDATE":{e.onClientsUpdate&&e.onClientsUpdate(s.clients);break}}}})}catch(x){throw new Error(`Failed to get node assignment: ${x.message}`)}}function de(t){return t||(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")?"http://localhost:9001":"https://nodes.modd.io")}async function he(t,e={}){const i=de(e.centralServiceUrl),n=e.limit||50,r=e.offset||0,u=`${i}/api/apps/${encodeURIComponent(t)}/rooms/list?limit=${n}&offset=${r}`,c=await fetch(u);if(!c.ok){const g=await c.json().catch(()=>({error:"Unknown error"}));throw new Error(g.error||`Failed to list rooms: ${c.statusText}`)}return await c.json()}async function ue(t,e={}){const i=de(e.centralServiceUrl),n=e.minClients??0,r=e.maxClients??999,u=`${i}/api/apps/${encodeURIComponent(t)}/rooms/random?minClients=${n}&maxClients=${r}`,c=await fetch(u);if(c.status===404)return null;if(!c.ok){const g=await c.json().catch(()=>({error:"Unknown error"}));throw new Error(g.error||`Failed to get random room: ${c.statusText}`)}return await c.json()}var ge=X;return typeof window<"u"&&(window.moddNetwork={connect:X,modd:ge,listRooms:he,getRandomRoom:ue,auth:ie}),Ae(re)})();
"use strict";var Modu=(()=>{var In=Object.defineProperty;var Eo=Object.getOwnPropertyDescriptor;var Io=Object.getOwnPropertyNames;var Do=Object.prototype.hasOwnProperty;var Dt=(i,e)=>{for(var t in e)In(i,t,{get:e[t],enumerable:!0})},To=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Io(e))!Do.call(i,o)&&o!==t&&In(i,o,{get:()=>e[o],enumerable:!(n=Eo(e,o))||n.enumerable});return i};var wo=i=>To(In({},"__esModule",{value:!0}),i);var Fs={};Dt(Fs,{AutoRenderer:()=>yt,BODY_DYNAMIC:()=>bi,BODY_KINEMATIC:()=>rt,BODY_STATIC:()=>st,Body2D:()=>$,Camera2D:()=>J,CameraSystem:()=>Qt,Entity:()=>at,EntityBuilder:()=>dt,EntityIdAllocator:()=>Re,EntityPool:()=>He,FP_2PI:()=>Kn,FP_HALF:()=>ee,FP_HALF_PI:()=>Zn,FP_ONE:()=>S,FP_PI:()=>jn,FP_SHIFT:()=>Gn,Game:()=>mt,INDEX_MASK:()=>B,InputPlugin:()=>Zt,MAX_ENTITIES:()=>oe,Physics2DSystem:()=>bt,Player:()=>te,Prefab:()=>ft,QueryEngine:()=>Ye,QueryIterator:()=>se,RollbackBuffer:()=>Yt,SHAPE_CIRCLE:()=>ze,SHAPE_RECT:()=>Ht,SPRITE_IMAGE:()=>zt,SYSTEM_PHASES:()=>nt,Simple2DRenderer:()=>yt,SparseSnapshotCodec:()=>Ae,Sprite:()=>ot,SystemScheduler:()=>Oe,Transform2D:()=>O,World:()=>qe,applyDelta:()=>Ti,assemblePartitions:()=>Di,codec:()=>An,computeDegradationTier:()=>Bi,computePartitionAssignment:()=>jt,computePartitionCount:()=>ht,computePartitionSeed:()=>Mn,computeSnapshotHash:()=>Ut,computeStateDelta:()=>Xt,createGame:()=>Ri,createPhysics2DSystem:()=>eo,dRandom:()=>vi,dSqrt:()=>wt,defineComponent:()=>ce,deserializeDelta:()=>Ei,deserializePartition:()=>Ii,disableDeterminismGuard:()=>Ai,enableDebugUI:()=>Vi,enableDeterminismGuard:()=>on,fpAbs:()=>I,fpAtan2:()=>ti,fpCeil:()=>ei,fpClamp:()=>ke,fpCos:()=>Ie,fpDiv:()=>C,fpFloor:()=>Jn,fpMax:()=>de,fpMin:()=>ie,fpMul:()=>u,fpSign:()=>Qn,fpSin:()=>ge,fpSqrt:()=>_,getClientPartitions:()=>Kt,getDeltaSize:()=>Gt,getEntityPartition:()=>$t,getPartition:()=>Wt,isClientAssigned:()=>wi,isDeltaEmpty:()=>ut,loadRandomState:()=>fe,physics2d:()=>On,physics3d:()=>Un,quatClone:()=>Si,quatConjugate:()=>kt,quatFromAxisAngle:()=>Nt,quatFromEulerY:()=>xi,quatIdentity:()=>tt,quatMul:()=>_t,quatNormalize:()=>Vt,quatRotateVec3:()=>j,saveRandomState:()=>he,serializeDelta:()=>Ci,toFixed:()=>g,toFloat:()=>w,vec2:()=>ni,vec2Add:()=>si,vec2Clone:()=>oi,vec2Cross:()=>li,vec2Distance:()=>ui,vec2DistanceSq:()=>hi,vec2Dot:()=>ci,vec2FromFixed:()=>ii,vec2Length:()=>At,vec2LengthSq:()=>Rt,vec2Lerp:()=>pi,vec2Neg:()=>ai,vec2Normalize:()=>di,vec2Scale:()=>ri,vec2Sub:()=>Bt,vec2Zero:()=>Dn,vec3:()=>V,vec3Add:()=>z,vec3Clone:()=>Pt,vec3Cross:()=>K,vec3Distance:()=>yi,vec3DistanceSq:()=>gi,vec3Dot:()=>H,vec3FromFloats:()=>De,vec3Length:()=>Mt,vec3LengthSq:()=>G,vec3Lerp:()=>mi,vec3Neg:()=>xe,vec3Normalize:()=>ue,vec3Scale:()=>R,vec3Sub:()=>L,vec3ToFloats:()=>fi,vec3Zero:()=>pe,weightedRandomPick:()=>Nn,xxhash32:()=>wn,xxhash32Combine:()=>Z,xxhash32String:()=>Fi});var Gn=16,S=65536,ee=32768,jn=205887,Kn=411775,Zn=102944;function g(i){return Math.round(i*65536)}function w(i){return i/65536}function u(i,e){return Number(BigInt(i)*BigInt(e)>>BigInt(16))}function C(i,e){return e===0?i>=0?2147483647:-2147483647:Number((BigInt(i)<<BigInt(16))/BigInt(e))}function I(i){return i<0?-i:i}function Qn(i){return i>0?65536:i<0?-65536:0}function ie(i,e){return i<e?i:e}function de(i,e){return i>e?i:e}function ke(i,e,t){return i<e?e:i>t?t:i}function Jn(i){return i&-65536}function ei(i){return i+65536-1&-65536}function _(i){if(i<=0)return 0;let e=BigInt(i)*BigInt(65536);if(e<=0n)return 0;let t=0n,n=e;for(;n>0n;)t++,n>>=1n;let o=1n<<(t>>1n);o===0n&&(o=1n);let s=0n;for(let r=0;r<30;r++){let c=o+e/o>>1n;if(c===o||c===s)break;s=o,o=c}for(;o*o>e;)o--;for(;(o+1n)*(o+1n)<=e;)o++;return Number(o)}function wt(i){return w(_(g(i)))}var Tt=256,Wn=[0,402,804,1206,1608,2010,2412,2814,3216,3617,4019,4420,4821,5222,5623,6023,6424,6824,7224,7623,8022,8421,8820,9218,9616,10014,10411,10808,11204,11600,11996,12391,12785,13180,13573,13966,14359,14751,15143,15534,15924,16314,16703,17091,17479,17867,18253,18639,19024,19409,19792,20175,20557,20939,21320,21699,22078,22457,22834,23210,23586,23961,24335,24708,25080,25451,25821,26190,26558,26925,27291,27656,28020,28383,28745,29106,29466,29824,30182,30538,30893,31248,31600,31952,32303,32652,33e3,33347,33692,34037,34380,34721,35062,35401,35738,36075,36410,36744,37076,37407,37736,38064,38391,38716,39040,39362,39683,40002,40320,40636,40951,41264,41576,41886,42194,42501,42806,43110,43412,43713,44011,44308,44604,44898,45190,45480,45769,46056,46341,46624,46906,47186,47464,47741,48015,48288,48559,48828,49095,49361,49624,49886,50146,50404,50660,50914,51166,51417,51665,51911,52156,52398,52639,52878,53114,53349,53581,53812,54040,54267,54491,54714,54934,55152,55368,55582,55794,56004,56212,56418,56621,56823,57022,57219,57414,57607,57798,57986,58172,58356,58538,58718,58896,59071,59244,59415,59583,59750,59914,60075,60235,60392,60547,60700,60851,60999,61145,61288,61429,61568,61705,61839,61971,62101,62228,62353,62476,62596,62714,62830,62943,63054,63162,63268,63372,63473,63572,63668,63763,63854,63944,64031,64115,64197,64277,64354,64429,64501,64571,64639,64704,64766,64827,64884,64940,64993,65043,65091,65137,65180,65220,65259,65294,65328,65358,65387,65413,65436,65457,65476,65492,65505,65516,65525,65531,65535,65536],Bo=10680707;function ge(i){if(i<0){let p=(-i/411775|0)+1;i+=p*411775}i>=411775&&(i=i%411775);let e=0;i>=205887&&(i-=205887,e=2),i>=102944&&(i=205887-i,e+=1);let t=u(i,Bo),n=t>>16,o=t&65535,s=n<0?0:n>Tt?Tt:n,r=n+1,c=r<0?0:r>Tt?Tt:r,l=Wn[s]??0,a=Wn[c]??65536,d=l+u(a-l,o);return e>=2&&(d=-d),d}function Ie(i){return ge(i+102944)}function ti(i,e){if(e===0&&i===0)return 0;let t=I(e),n=I(i),o;if(t>=n){let s=C(n,t);o=u(s,51472)}else{let s=C(t,n);o=102944-u(s,51472)}return e<0&&(o=205887-o),i<0&&(o=-o),o}function ni(i,e){return{x:g(i),y:g(e)}}function Dn(){return{x:0,y:0}}function ii(i,e){return{x:i,y:e}}function oi(i){return{x:i.x,y:i.y}}function si(i,e){return{x:i.x+e.x,y:i.y+e.y}}function Bt(i,e){return{x:i.x-e.x,y:i.y-e.y}}function ri(i,e){return{x:u(i.x,e),y:u(i.y,e)}}function ai(i){return{x:-i.x,y:-i.y}}function ci(i,e){return u(i.x,e.x)+u(i.y,e.y)}function li(i,e){return u(i.x,e.y)-u(i.y,e.x)}function Rt(i){return u(i.x,i.x)+u(i.y,i.y)}function At(i){return _(Rt(i))}function di(i){let e=At(i);return e===0?Dn():{x:C(i.x,e),y:C(i.y,e)}}function pi(i,e,t){let n=65536-t;return{x:u(i.x,n)+u(e.x,t),y:u(i.y,n)+u(e.y,t)}}function ui(i,e){return At(Bt(e,i))}function hi(i,e){return Rt(Bt(e,i))}function V(i,e,t){return{x:i,y:e,z:t}}function pe(){return{x:0,y:0,z:0}}function De(i,e,t){return{x:g(i),y:g(e),z:g(t)}}function fi(i){return{x:w(i.x),y:w(i.y),z:w(i.z)}}function Pt(i){return{x:i.x,y:i.y,z:i.z}}function z(i,e){return{x:i.x+e.x,y:i.y+e.y,z:i.z+e.z}}function L(i,e){return{x:i.x-e.x,y:i.y-e.y,z:i.z-e.z}}function R(i,e){return{x:u(i.x,e),y:u(i.y,e),z:u(i.z,e)}}function xe(i){return{x:-i.x,y:-i.y,z:-i.z}}function H(i,e){return u(i.x,e.x)+u(i.y,e.y)+u(i.z,e.z)}function K(i,e){return{x:u(i.y,e.z)-u(i.z,e.y),y:u(i.z,e.x)-u(i.x,e.z),z:u(i.x,e.y)-u(i.y,e.x)}}function G(i){return u(i.x,i.x)+u(i.y,i.y)+u(i.z,i.z)}function Mt(i){return _(G(i))}function ue(i){let e=Mt(i);return e===0?pe():{x:C(i.x,e),y:C(i.y,e),z:C(i.z,e)}}function mi(i,e,t){let n=65536-t;return{x:u(i.x,n)+u(e.x,t),y:u(i.y,n)+u(e.y,t),z:u(i.z,n)+u(e.z,t)}}function yi(i,e){return Mt(L(e,i))}function gi(i,e){return G(L(e,i))}function tt(){return{x:0,y:0,z:0,w:65536}}function Nt(i,e){let t=e>>1,n=ge(t),o=Ie(t),s=ue(i);return{x:u(s.x,n),y:u(s.y,n),z:u(s.z,n),w:o}}function xi(i){let e=i>>1;return{x:0,y:ge(e),z:0,w:Ie(e)}}function _t(i,e){return{x:u(i.w,e.x)+u(i.x,e.w)+u(i.y,e.z)-u(i.z,e.y),y:u(i.w,e.y)-u(i.x,e.z)+u(i.y,e.w)+u(i.z,e.x),z:u(i.w,e.z)+u(i.x,e.y)-u(i.y,e.x)+u(i.z,e.w),w:u(i.w,e.w)-u(i.x,e.x)-u(i.y,e.y)-u(i.z,e.z)}}function j(i,e){let t=V(i.x,i.y,i.z),n=K(t,e),o=K(t,n);return z(e,z(R(n,i.w<<1),R(o,131072)))}function Vt(i){let e=u(i.x,i.x)+u(i.y,i.y)+u(i.z,i.z)+u(i.w,i.w),t=_(e);return t===0?tt():{x:C(i.x,t),y:C(i.y,t),z:C(i.z,t),w:C(i.w,t)}}function kt(i){return{x:-i.x,y:-i.y,z:-i.z,w:i.w}}function Si(i){return{x:i.x,y:i.y,z:i.z,w:i.w}}var Se=1,Te=2;function Ro(){let i=Se,e=Te;return Se=e,i^=i<<23>>>0,i^=i>>>17,i^=e,i^=e>>>26,Te=i>>>0,Se+Te>>>0}function Ao(i){i=i>>>0,i===0&&(i=1);let e=i;e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,Se=(e>>>16^e)>>>0,e=i*2654435769>>>0,e=(e>>>16^e)*73244475>>>0,e=(e>>>16^e)*73244475>>>0,Te=(e>>>16^e)>>>0,Se===0&&Te===0&&(Se=1)}function vi(){return Ro()/4294967296}function he(){return{s0:Se,s1:Te}}function fe(i){Se=i.s0,Te=i.s1}Ao(1);var oe=1e4;var B=1048575;var nt=["input","update","prePhysics","physics","postPhysics","render"];function Po(i){if(typeof i=="object"&&i!==null&&"type"in i){let e=i;return e.type==="f32"&&console.warn("Component field uses f32 which is NON-DETERMINISTIC. Only use for render-only data, never for synced state."),{type:e.type,default:e.default??(e.type==="bool"?!1:0)}}if(typeof i=="boolean")return{type:"bool",default:i};if(typeof i=="number")return{type:"i32",default:i};if(i==null)return{type:"i32",default:0};throw new Error(`Unsupported field type: ${typeof i}. Components can only contain numbers and booleans. Use game.internString() for string values.`)}function Mo(i){switch(i){case"i32":return new Int32Array(1e4);case"u8":case"bool":return new Uint8Array(1e4);case"f32":return new Float32Array(1e4);default:throw new Error(`Unknown field type: ${i}`)}}function No(i){let e={};for(let[t,n]of Object.entries(i))e[t]=Mo(n.type);return{mask:new Uint32Array(Math.ceil(1e4/32)),fields:e,schema:i}}function _o(i,e,t){let n=function(o){this._index=o};n.prototype={};for(let[o,s]of Object.entries(e)){let r=t.fields[o],c=s.type==="i32",l=s.type==="bool";Object.defineProperty(n.prototype,o,{get:function(){let a=r[this._index];return l?a!==0:c?w(a):a},set:function(a){l?r[this._index]=a?1:0:c?r[this._index]=g(a):r[this._index]=a},enumerable:!0,configurable:!1})}return Object.defineProperty(n.prototype,"_index",{value:0,writable:!0,enumerable:!1,configurable:!1}),n}var Tn=new Map;function ce(i,e,t){if(Tn.has(i))throw new Error(`Component '${i}' is already defined`);let n={};for(let[c,l]of Object.entries(e))n[c]=Po(l);let o=No(n),s=_o(i,n,o),r={name:i,schema:n,storage:o,AccessorClass:s,fieldNames:Object.keys(n),sync:t?.sync!==!1};return Tn.set(i,r),r}function ve(i,e){let t=e>>>5,n=1<<(e&31);return(i.mask[t]&n)!==0}function we(i,e){let t=e>>>5,n=1<<(e&31);i.mask[t]|=n}function Le(i,e){let t=e>>>5,n=1<<(e&31);i.mask[t]&=~n}function it(i,e){for(let[t,n]of Object.entries(i.schema)){let o=i.fields[t];n.type==="i32"?o[e]=g(n.default):n.type==="bool"?o[e]=n.default?1:0:o[e]=n.default}}function Be(){return Tn}var Re=class{constructor(){this.freeList=[];this.nextIndex=0;this.generations=new Uint16Array(1e4)}allocate(){let e;if(this.freeList.length>0)e=this.freeList.shift();else{if(this.nextIndex>=1e4)throw new Error(`Entity limit exceeded (MAX_ENTITIES=${1e4}). Consider destroying unused entities or increasing the limit.`);e=this.nextIndex++}return this.generations[e]<<20|e}free(e){let t=e&1048575;this.generations[t]=this.generations[t]+1&4095;let n=this.findInsertIndex(t);this.freeList.splice(n,0,t)}isValid(e){let t=e&1048575,n=e>>>20;return t<this.nextIndex&&this.generations[t]===n}getIndex(e){return e&1048575}getGeneration(e){return e>>>20}getState(){return{nextIndex:this.nextIndex,freeList:[...this.freeList],generations:Array.from(this.generations.slice(0,this.nextIndex))}}setState(e){this.nextIndex=e.nextIndex,this.freeList=[...e.freeList];for(let t=0;t<e.generations.length;t++)this.generations[t]=e.generations[t]}reset(){this.nextIndex=0,this.freeList=[],this.generations.fill(0)}getActiveCount(){return this.nextIndex-this.freeList.length}getNextId(){return this.nextIndex}setNextId(e){this.nextIndex=e}allocateSpecific(e){let t=e&1048575,n=e>>>20;t>=this.nextIndex&&(this.nextIndex=t+1);let o=this.freeList.indexOf(t);return o!==-1&&this.freeList.splice(o,1),this.generations[t]=n,e}findInsertIndex(e){let t=0,n=this.freeList.length;for(;t<n;){let o=t+n>>>1;this.freeList[o]<e?t=o+1:n=o}return t}};var O=ce("Transform2D",{x:0,y:0,angle:0}),$=ce("Body2D",{vx:0,vy:0,angularVelocity:0,forceX:0,forceY:0,impulseX:0,impulseY:0,width:0,height:0,radius:0,mass:1,restitution:0,friction:0,bodyType:0,shapeType:1,damping:0,isSensor:!1}),te=ce("Player",{clientId:0}),ot=ce("Sprite",{shape:1,width:0,height:0,radius:10,color:0,spriteId:0,offsetX:0,offsetY:0,scaleX:1,scaleY:1,layer:0,visible:!0}),zt=2,J=ce("Camera2D",{x:0,y:0,zoom:1,targetZoom:1,smoothing:.1,followEntity:0,viewportWidth:0,viewportHeight:0},{sync:!1}),bi=0,st=1,rt=2,Ht=0,ze=1;var at=class{constructor(){this.eid=-1;this.type="";this.destroyed=!1;this.render={prevX:0,prevY:0,interpX:0,interpY:0,screenX:0,screenY:0,visible:!0};this._components=[];this._accessors=new Map;this._world=null;this._inputData=null}get(e){let t=this.eid&1048575;if(!ve(e.storage,t))throw new Error(`Entity ${this.eid} (type: ${this.type}) does not have component '${e.name}'`);let n=this._accessors.get(e);return n?n._index=t:(n=new e.AccessorClass(t),this._accessors.set(e,n)),n}has(e){return ve(e.storage,this.eid&1048575)}addComponent(e,t){let n=this.eid&1048575;if(ve(e.storage,n))throw new Error(`Entity ${this.eid} already has component '${e.name}'`);we(e.storage,n),it(e.storage,n),this._components.push(e),this._world&&this._world.queryEngine.addComponent(this.eid,e);let o=this.get(e);if(t)for(let[s,r]of Object.entries(t))o[s]=r;return o}removeComponent(e){let t=this.eid&1048575;if(!ve(e.storage,t))throw new Error(`Entity ${this.eid} does not have component '${e.name}'`);Le(e.storage,t);let n=this._components.indexOf(e);n!==-1&&this._components.splice(n,1),this._world&&this._world.queryEngine.removeComponent(this.eid,e),this._accessors.delete(e)}destroy(){this.destroyed||(this.destroyed=!0,this._world&&this._world.destroyEntity(this))}getComponents(){return[...this._components]}get input(){return this._inputData}_setInputData(e){this._inputData=e}_savePreviousState(){for(let e of this._components){let t=this.eid&1048575;if("x"in e.storage.fields&&"y"in e.storage.fields){let n=e.storage.fields.x,o=e.storage.fields.y;this.render.prevX=w(n[t]),this.render.prevY=w(o[t]);return}}}interpolate(e){for(let t of this._components){let n=this.eid&1048575;if("x"in t.storage.fields&&"y"in t.storage.fields){let o=w(t.storage.fields.x[n]),s=w(t.storage.fields.y[n]);this.render.interpX=this.render.prevX+(o-this.render.prevX)*e,this.render.interpY=this.render.prevY+(s-this.render.prevY)*e;return}}}_init(e,t,n,o){this.eid=e,this.type=t,this.destroyed=!1,this._components=n,this._world=o,this._accessors.clear(),this.render.prevX=0,this.render.prevY=0,this.render.interpX=0,this.render.interpY=0,this.render.screenX=0,this.render.screenY=0,this.render.visible=!0,this._inputData=null}_cleanup(){this._world=null,this._components=[],this._accessors.clear(),this._inputData=null}moveTowards(e,t){if(!this.has(O)||!this.has($))return;let n=this.get(O),o=this.get($),s=g(e.x)-g(n.x),r=g(e.y)-g(n.y),c=u(s,s)+u(r,r);if(c===0){o.vx=0,o.vy=0;return}let l=_(c),a=g(t*60);o.vx=w(C(u(s,a),l)),o.vy=w(C(u(r,a),l))}moveTowardsWithStop(e,t,n){if(!this.has(O)||!this.has($))return;let o=this.get(O),s=this.get($),r=g(e.x)-g(o.x),c=g(e.y)-g(o.y),l=u(r,r)+u(c,c),a=g(n),d=u(a,a);if(l<=d){s.vx=0,s.vy=0;return}let p=_(l),h=g(t*60);s.vx=w(C(u(r,h),p)),s.vy=w(C(u(c,h),p))}stop(){if(!this.has($))return;let e=this.get($);e.vx=0,e.vy=0}setVelocity(e,t){if(!this.has($))return;let n=this.get($);n.vx=e,n.vy=t}distanceTo(e){if(!this.has(O))return 0;let t=this.get(O),n=g(e.x)-g(t.x),o=g(e.y)-g(t.y),s=u(n,n)+u(o,o);return w(_(s))}isWithin(e,t){if(!this.has(O))return!1;let n=this.get(O),o=g(e.x)-g(n.x),s=g(e.y)-g(n.y),r=u(o,o)+u(s,s),c=g(t),l=u(c,c);return r<=l}},He=class{constructor(){this.pool=[];this.active=new Map}acquire(e){let t=this.active.get(e);return t||(t=this.pool.pop()||new at,this.active.set(e,t),t)}release(e){let t=this.active.get(e);t&&(t._cleanup(),this.active.delete(e),this.pool.push(t))}get(e){return this.active.get(e)}has(e){return this.active.has(e)}clear(){for(let e of this.active.values())e._cleanup(),this.pool.push(e);this.active.clear()}get size(){return this.active.size}};var se=class{constructor(e,t,n){this.index=0;this.eids=e.slice(),this.getEntity=t,this.isDestroyed=n}[Symbol.iterator](){return this.index=0,{next:()=>{for(;this.index<this.eids.length;){let e=this.eids[this.index++];if(this.isDestroyed(e))continue;let t=this.getEntity(e);if(t)return{done:!1,value:t}}return{done:!0,value:void 0}}}}toArray(){let e=[];for(let t of this)e.push(t);return e}first(){for(let e of this)return e;return null}find(e){for(let t of this)if(e(t))return t;return null}count(){let e=0;for(let t of this)e++;return e}},Ye=class{constructor(e,t){this.typeIndex=new Map;this.componentIndex=new Map;this.clientIdIndex=new Map;this.getEntity=e,this.isDestroyed=t}addEntity(e,t,n,o){let s=this.typeIndex.get(t);s||(s=new Set,this.typeIndex.set(t,s)),s.add(e);for(let r of n){let c=this.componentIndex.get(r);c||(c=new Set,this.componentIndex.set(r,c)),c.add(e)}o!==void 0&&this.clientIdIndex.set(o,e)}removeEntity(e,t,n,o){this.typeIndex.get(t)?.delete(e);for(let s of n)this.componentIndex.get(s)?.delete(e);o!==void 0&&this.clientIdIndex.get(o)===e&&this.clientIdIndex.delete(o)}addComponent(e,t){let n=this.componentIndex.get(t);n||(n=new Set,this.componentIndex.set(t,n)),n.add(e)}removeComponent(e,t){this.componentIndex.get(t)?.delete(e)}setClientId(e,t){this.clientIdIndex.set(t,e)}removeClientId(e){this.clientIdIndex.delete(e)}byType(e){let t=this.typeIndex.get(e),n=t?this.sortedEids(t):[];return new se(n,this.getEntity,this.isDestroyed)}byComponents(...e){if(e.length===0)return new se([],this.getEntity,this.isDestroyed);let t,n=1/0;for(let s of e){let r=this.componentIndex.get(s);if(!r||r.size===0)return new se([],this.getEntity,this.isDestroyed);r.size<n&&(n=r.size,t=r)}if(!t)return new se([],this.getEntity,this.isDestroyed);let o=[];for(let s of t){let r=!0;for(let c of e)if(c.storage&&!ve(c.storage,s&1048575)){r=!1;break}r&&o.push(s)}return o.sort((s,r)=>s-r),new se(o,this.getEntity,this.isDestroyed)}query(e,...t){if(typeof e=="string"){if(t.length>0){let n=this.typeIndex.get(e);if(!n||n.size===0)return new se([],this.getEntity,this.isDestroyed);let o=[];for(let s of n){let r=!0;for(let c of t)if(c.storage&&!ve(c.storage,s&1048575)){r=!1;break}r&&o.push(s)}return o.sort((s,r)=>s-r),new se(o,this.getEntity,this.isDestroyed)}return this.byType(e)}return this.byComponents(e,...t)}getByClientId(e){return this.clientIdIndex.get(e)}getAllEids(){let e=new Set;for(let t of this.typeIndex.values())for(let n of t)e.add(n);return Array.from(e).sort((t,n)=>t-n)}clear(){this.typeIndex.clear(),this.componentIndex.clear(),this.clientIdIndex.clear()}sortedEids(e){return Array.from(e).sort((t,n)=>t-n)}};var Oe=class{constructor(){this.systems=new Map;this.isClient=!0;this.nextSystemId=0;for(let e of nt)this.systems.set(e,[])}setIsClient(e){this.isClient=e}add(e,t={}){let n=t.phase||"update",o=this.systems.get(n);if(!o)throw new Error(`Unknown system phase: ${n}`);let s={fn:e,options:t,order:t.order??this.nextSystemId++};return o.push(s),o.sort((r,c)=>r.order-c.order),()=>this.remove(e)}remove(e){for(let t of this.systems.values()){let n=t.findIndex(o=>o.fn===e);if(n!==-1)return t.splice(n,1),!0}return!1}runPhase(e){let t=this.systems.get(e);if(t){for(let n of t)if(!(n.options.client&&!this.isClient)&&!(n.options.server&&this.isClient))try{let o=n.fn();if(o&&typeof o=="object"&&"then"in o)throw new Error("System returned a Promise. Async systems are not allowed as they break determinism. Remove 'await' from your system.")}catch(o){throw console.error(`Error in system during '${e}' phase:`,o),o}}}runAll(){for(let e of nt)e==="render"&&!this.isClient||this.runPhase(e)}getSystemCounts(){let e={};for(let[t,n]of this.systems)e[t]=n.length;return e}clear(){for(let e of this.systems.values())e.length=0;this.nextSystemId=0}};var Ae=class{encode(e,t,n,o,s,r,c=0,l=0,a){let d=[],p=[...e].sort((y,m)=>y-m);for(let y of p)d.push({eid:y,type:t(y),clientId:n(y)});let h=new Map,f=Be();for(let[y,m]of f){if(!m.sync||m.fieldNames.length===0)continue;let v=0;for(let b of m.fieldNames){let D=m.storage.fields[b];v+=p.length*D.BYTES_PER_ELEMENT}let E=new ArrayBuffer(v),F=0;for(let b of m.fieldNames){let D=m.storage.fields[b],M=D.BYTES_PER_ELEMENT,A=new D.constructor(E,F,p.length);for(let N=0;N<p.length;N++){let q=p[N]&1048575;A[N]=D[q]}F+=p.length*M}h.set(y,E)}return{frame:c,seq:l,entityMeta:d,componentData:h,entityCount:p.length,allocator:s,strings:r,rng:a}}decode(e,t,n,o,s,r){t(),n(e.allocator),o(e.strings),e.rng&&r&&r(e.rng);let c=Be();for(let l=0;l<e.entityMeta.length;l++){let a=e.entityMeta[l];s(a.eid,a.type,a.clientId)}for(let[l,a]of e.componentData){let d=c.get(l);if(!d)continue;let p=0;for(let h of d.fieldNames){let f=d.storage.fields[h],y=f.BYTES_PER_ELEMENT,m=new f.constructor(a,p,e.entityCount);for(let x=0;x<e.entityMeta.length;x++){let v=e.entityMeta[x].eid&1048575;f[v]=m[x]}p+=e.entityCount*y}}}getSize(e){let t=0;t+=e.entityMeta.length*32;for(let n of e.componentData.values())t+=n.byteLength;return t+=e.allocator.freeList.length*4,t+=e.allocator.generations.length*2,t}toBinary(e){let t=JSON.stringify({frame:e.frame,seq:e.seq,entityMeta:e.entityMeta,allocator:e.allocator,strings:e.strings,rng:e.rng,componentNames:Array.from(e.componentData.keys())}),n=new TextEncoder().encode(t),o=n.length,s=0;for(let d of e.componentData.values())s+=d.byteLength;let r=4+o+s,c=new ArrayBuffer(r),l=new DataView(c),a=0;l.setUint32(a,o,!0),a+=4,new Uint8Array(c,a,o).set(n),a+=o;for(let d of e.componentData.values())new Uint8Array(c,a,d.byteLength).set(new Uint8Array(d)),a+=d.byteLength;return c}fromBinary(e){let t=new DataView(e),n=0,o=t.getUint32(n,!0);n+=4;let s=new Uint8Array(e,n,o),r=new TextDecoder().decode(s),c=JSON.parse(r);n+=o;let l=new Map,a=Be();for(let d of c.componentNames){let p=a.get(d);if(!p)continue;let h=0;for(let y of p.fieldNames){let m=p.storage.fields[y];h+=c.entityMeta.length*m.BYTES_PER_ELEMENT}let f=e.slice(n,n+h);l.set(d,f),n+=h}return{frame:c.frame,seq:c.seq,entityMeta:c.entityMeta,componentData:l,entityCount:c.entityMeta.length,allocator:c.allocator,strings:c.strings,rng:c.rng}}},Yt=class{constructor(e=60){this.maxFrames=e;this.snapshots=new Map;this.codec=new Ae}save(e,t){this.snapshots.set(e,t);let n=e-this.maxFrames+1;for(let o of this.snapshots.keys())o<n&&this.snapshots.delete(o)}get(e){return this.snapshots.get(e)}has(e){return this.snapshots.has(e)}getOldestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t<e)&&(e=t);return e}getNewestFrame(){let e;for(let t of this.snapshots.keys())(e===void 0||t>e)&&(e=t);return e}clear(){this.snapshots.clear()}get size(){return this.snapshots.size}};var Ot=class{constructor(){this.stringToId=new Map;this.idToString=new Map;this.nextId=new Map}intern(e,t){let n=this.stringToId.get(e);n||(n=new Map,this.stringToId.set(e,n));let o=n.get(t);if(o!==void 0)return o;let s=this.nextId.get(e)??1;this.nextId.set(e,s+1),n.set(t,s);let r=this.idToString.get(e);return r||(r=new Map,this.idToString.set(e,r)),r.set(s,t),s}getString(e,t){return this.idToString.get(e)?.get(t)??null}getState(){let e={},t={};for(let[n,o]of this.stringToId)e[n]=Object.fromEntries(o),t[n]=this.nextId.get(n)??1;return{tables:e,nextIds:t}}setState(e){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear();for(let[t,n]of Object.entries(e.tables)){let o=new Map(Object.entries(n));this.stringToId.set(t,o);let s=new Map;for(let[r,c]of o)s.set(c,r);this.idToString.set(t,s),this.nextId.set(t,e.nextIds[t]??1)}}clear(){this.stringToId.clear(),this.idToString.clear(),this.nextId.clear()}};function me(i,e){return(i>>>0)+(e>>>0)>>>0}function ne(i,e){let t=i&65535,n=i>>>16,o=e&65535,s=e>>>16,r=t*o,c=t*s,l=n*o;return r+(c+l<<16)>>>0}function be(i,e){return(i<<e|i>>>32-e)>>>0}function ct(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24)>>>0}function qt(i,e){return i=me(i,ne(e,2246822519)),i=be(i,13),i=ne(i,2654435761),i}function wn(i,e=0){e=e>>>0;let t=i.length,n,o=0;if(t>=16){let s=me(me(e,2654435761),2246822519),r=me(e,2246822519),c=e,l=e-2654435761>>>0,a=t-16;do s=qt(s,ct(i,o)),o+=4,r=qt(r,ct(i,o)),o+=4,c=qt(c,ct(i,o)),o+=4,l=qt(l,ct(i,o)),o+=4;while(o<=a);n=be(s,1)+be(r,7)+be(c,12)+be(l,18),n=n>>>0}else n=me(e,374761393);for(n=me(n,t);o+4<=t;)n=me(n,ne(ct(i,o),3266489917)),n=ne(be(n,17),668265263),o+=4;for(;o<t;)n=me(n,ne(i[o],374761393)),n=ne(be(n,11),2654435761),o++;return n^=n>>>15,n=ne(n,2246822519),n^=n>>>13,n=ne(n,3266489917),n^=n>>>16,n>>>0}function Fi(i,e=0){let t=new TextEncoder;return wn(t.encode(i),e)}function Z(i,e){let t=me(i,ne(e>>>0,3266489917));return t=ne(be(t,17),668265263),t^=t>>>15,t=ne(t,2246822519),t^=t>>>13,t=ne(t,3266489917),t^=t>>>16,t>>>0}var dt=class{constructor(e,t){this.world=e;this.name=t;this.components=[];this.registered=!1}with(e,t){return this.components.push({type:e,defaults:t}),this.register(),this}_setSyncFields(e){this._syncFields=e}_setOnRestore(e){this._onRestore=e}register(){this.world._registerEntityDef({name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore})}_ensureRegistered(){this.registered||(this.registered=!0),this.register()}_getDefinition(){return{name:this.name,components:this.components,syncFields:this._syncFields,onRestore:this._onRestore}}},lt=1073741824,qe=class{constructor(){this.entityDefs=new Map;this.activeEntities=new Set;this.entityTypes=new Map;this.entityComponents=new Map;this.entityClientIds=new Map;this.inputRegistry=new Map;this._isClient=!0;this.snapshotCodec=new Ae;this.frame=0;this.seq=0;this.inputBuffer=new Map;this._isSimulating=!1;this.localClientId=null;this.idAllocator=new Re,this.localIdAllocator=new Re,this.entityPool=new He,this.strings=new Ot,this.queryEngine=new Ye(e=>this.getEntity(e),e=>this.isDestroyed(e)),this.scheduler=new Oe,this.addSystem(()=>this.saveInterpolationState(),{phase:"prePhysics",order:-1e3})}setIsClient(e){this._isClient=e,this.scheduler.setIsClient(e)}get isClient(){return this._isClient}defineComponent(e,t){return ce(e,t)}defineEntity(e){return new dt(this,e)}_registerEntityDef(e){this.entityDefs.set(e.name,e)}getEntityDef(e){return this.entityDefs.get(e)}spawn(e,t={}){let n;if(typeof e=="string")n=e;else{let p=e._getDefinition();this._registerEntityDef(p),n=p.name}let o=this.entityDefs.get(n);if(!o)throw new Error(`Unknown entity type: '${n}'`);let s=o.syncFields&&o.syncFields.length===0,r;s?r=this.localIdAllocator.allocate()|lt:r=this.idAllocator.allocate();let c=r&1048575,l=this.entityPool.acquire(r);this.activeEntities.add(r),this.entityTypes.set(r,n);let a=[];for(let p of o.components){let h=p.type;if(a.push(h),we(h.storage,c),it(h.storage,c),p.defaults)for(let[f,y]of Object.entries(p.defaults)){let m=h.storage.fields[f];if(m){let x=h.storage.schema[f];x.type==="i32"?m[c]=g(y):x.type==="bool"?m[c]=y?1:0:m[c]=y}}}let d;for(let[p,h]of Object.entries(t)){p==="clientId"&&(d=h,this.entityClientIds.set(r,d));for(let f of a)if(p in f.storage.schema){let y=f.storage.fields[p],m=f.storage.schema[p];m.type==="i32"?y[c]=g(h):m.type==="bool"?y[c]=h?1:0:y[c]=h;break}}if(this.entityComponents.set(r,a),l._init(r,n,a,this),t.x!==void 0||t.y!==void 0){let p=t.x??0,h=t.y??0;l.render.prevX=p,l.render.prevY=h,l.render.interpX=p,l.render.interpY=h}return this.queryEngine.addEntity(r,n,a,d),l}spawnWithId(e,t,n={}){let o;if(typeof e=="string")o=e;else{let p=e._getDefinition();this._registerEntityDef(p),o=p.name}let s=this.entityDefs.get(o);if(!s)throw new Error(`Unknown entity type: '${o}'`);let r=this.idAllocator.allocateSpecific(t),c=r&1048575,l=this.entityPool.acquire(r);this.activeEntities.add(r),this.entityTypes.set(r,o);let a=[];for(let p of s.components){let h=p.type;if(a.push(h),we(h.storage,c),it(h.storage,c),p.defaults)for(let[f,y]of Object.entries(p.defaults)){let m=h.storage.fields[f];if(m){let x=h.storage.schema[f];x.type==="i32"?m[c]=g(y):x.type==="bool"?m[c]=y?1:0:m[c]=y}}}let d;for(let[p,h]of Object.entries(n)){p==="clientId"&&(d=h,this.entityClientIds.set(r,d));for(let f of s.components){let y=f.type.storage.fields[p];if(y){let m=f.type.storage.schema[p];m.type==="i32"?y[c]=g(h):m.type==="bool"?y[c]=h?1:0:y[c]=h;break}}}if(this.entityComponents.set(r,a),l._init(r,o,a,this),n.x!==void 0||n.y!==void 0){let p=n.x??0,h=n.y??0;l.render.prevX=p,l.render.prevY=h,l.render.interpX=p,l.render.interpY=h}return this.queryEngine.addEntity(r,o,a,d),l}destroyEntity(e){let t=e.eid;if(!this.activeEntities.has(t))return;let n=this.entityTypes.get(t)||"",o=this.entityComponents.get(t)||[],s=this.entityClientIds.get(t),r=t&1048575;for(let c of o)Le(c.storage,r);this.queryEngine.removeEntity(t,n,o,s),this.activeEntities.delete(t),this.entityTypes.delete(t),this.entityComponents.delete(t),this.entityClientIds.delete(t),this.entityPool.release(t),t&lt?this.localIdAllocator.free(t&~lt):this.idAllocator.free(t)}getEntity(e){if(!this.activeEntities.has(e))return null;let t=this.entityPool.get(e);return t&&!t.destroyed?t:null}isDestroyed(e){return!this.activeEntities.has(e)}getEntityByClientId(e){let t=this.queryEngine.getByClientId(e);return t===void 0?null:this.getEntity(t)}setEntityClientId(e,t){this.entityClientIds.set(e,t),this.queryEngine.setClientId(e,t)}query(e,...t){return this.queryEngine.query(e,...t)}getAllEntities(){let e=[],t=Array.from(this.activeEntities).sort((n,o)=>n-o);for(let n of t){let o=this.entityPool.get(n);o&&e.push(o)}return e}getAllEntityIds(){return Array.from(this.activeEntities).sort((e,t)=>e-t)}addSystem(e,t){return this.scheduler.add(e,t)}runSystems(){this.scheduler.runAll()}internString(e,t){return this.strings.intern(e,t)}getString(e,t){return this.strings.getString(e,t)}setInput(e,t){this.inputRegistry.set(e,t);let n=this.getEntityByClientId(e);n&&n._setInputData(t)}getInput(e){return this.inputRegistry.get(e)}clearInputs(){this.inputRegistry.clear()}getInputState(){let e={};for(let[t,n]of this.inputRegistry)e[t]=n;return e}setInputState(e){this.inputRegistry.clear();for(let[t,n]of Object.entries(e)){let o=parseInt(t,10);this.inputRegistry.set(o,n);let s=this.getEntityByClientId(o);s&&s._setInputData(n)}}getState(){let e=[];for(let t of this.activeEntities){let n=this.entityTypes.get(t),o=this.entityComponents.get(t)||[],s=t&1048575,r={};for(let c of o){let l={};for(let[a,d]of Object.entries(c.storage.fields))l[a]=d[s];r[c.name]=l}e.push({eid:t,type:n,components:r,clientId:this.entityClientIds.get(t)})}return{entities:e,allocator:this.idAllocator.getState(),strings:this.strings.getState()}}setState(e){this.clear(),this.idAllocator.setState(e.allocator),this.strings.setState(e.strings);for(let t of e.entities){let n=this.entityDefs.get(t.type);if(!n){console.warn(`Unknown entity type in snapshot: ${t.type}`);continue}let o=t.eid,s=o&1048575,r=this.entityPool.acquire(o);this.activeEntities.add(o),this.entityTypes.set(o,t.type),t.clientId!==void 0&&this.entityClientIds.set(o,t.clientId);let c=[];for(let l of n.components){let a=l.type;c.push(a),we(a.storage,s);let d=t.components[a.name];if(d)for(let[p,h]of Object.entries(d)){let f=a.storage.fields[p];f&&(f[s]=h)}}this.entityComponents.set(o,c),r._init(o,t.type,c,this),this.queryEngine.addEntity(o,t.type,c,t.clientId)}}clear(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],n=e&1048575;for(let o of t)Le(o.storage,n);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear(),this.idAllocator.reset(),this.localIdAllocator.reset(),this.strings.clear()}reset(){this.clear()}get entityCount(){return this.activeEntities.size}getSparseSnapshot(){return this.snapshotCodec.encode(Array.from(this.activeEntities),e=>this.entityTypes.get(e)||"",e=>this.entityClientIds.get(e),e=>this.entityComponents.get(e)||[],this.idAllocator.getState(),this.strings.getState(),this.frame,this.seq,he())}loadSparseSnapshot(e){let t=new Map;for(let n of this.activeEntities){let o=this.entityPool.get(n);o&&t.set(n,{x:o.render.interpX,y:o.render.interpY})}this.snapshotCodec.decode(e,()=>this.clearForSnapshot(),n=>this.idAllocator.setState(n),n=>this.strings.setState(n),(n,o,s)=>this.createEntityFromSnapshot(n,o,s),n=>{n&&fe(n)}),this.frame=e.frame,this.seq=e.seq,this.syncRenderStateFromTransforms(t)}syncRenderStateFromTransforms(e){for(let t of this.activeEntities){let n=this.getEntity(t);if(!n)continue;let o=e.get(t);o&&(n.render.prevX=o.x,n.render.prevY=o.y);let s=this.entityComponents.get(t)||[],r=t&1048575;for(let c of s)if(c.name==="Transform2D"){let l=c.storage.fields.x,a=c.storage.fields.y;l&&a&&(n.render.interpX=l[r]/65536,n.render.interpY=a[r]/65536);break}}}clearForSnapshot(){for(let e of this.activeEntities){let t=this.entityComponents.get(e)||[],n=e&1048575;for(let o of t)Le(o.storage,n);this.entityPool.release(e)}this.activeEntities.clear(),this.entityTypes.clear(),this.entityComponents.clear(),this.entityClientIds.clear(),this.queryEngine.clear()}createEntityFromSnapshot(e,t,n){let o=this.entityDefs.get(t);if(!o){console.warn(`Unknown entity type in snapshot: ${t}`);return}let s=e&1048575,r=this.entityPool.acquire(e);this.activeEntities.add(e),this.entityTypes.set(e,t),n!==void 0&&this.entityClientIds.set(e,n);let c=[];for(let l of o.components){let a=l.type;c.push(a),we(a.storage,s)}this.entityComponents.set(e,c),r._init(e,t,c,this),this.queryEngine.addEntity(e,t,c,n)}snapshotToBinary(e){return this.snapshotCodec.toBinary(e)}snapshotFromBinary(e){return this.snapshotCodec.fromBinary(e)}getSnapshotSize(e){return this.snapshotCodec.getSize(e)}tick(e,t=[]){this.frame=e,this.applyNetworkInputs(t),this._isSimulating=!0;try{this.scheduler.runPhase("input"),this.scheduler.runPhase("update"),this.scheduler.runPhase("prePhysics"),this.scheduler.runPhase("physics"),this.scheduler.runPhase("postPhysics")}finally{this._isSimulating=!1}this._isClient&&this.scheduler.runPhase("render"),this.inputBuffer.clear()}applyNetworkInputs(e){for(let t of e){let n=this.getEntityByClientId(t.clientId);if(n){this.inputBuffer.set(t.clientId,t.data);let o=t.data;o&&n._setInputData(o)}}}getInputForClient(e){return this.inputBuffer.get(e)}hasInputForClient(e){return this.inputBuffer.has(e)}runPhysics(){this.scheduler.runPhase("physics")}setPhysicsStep(e){return this.addSystem(e,{phase:"physics",order:0})}saveInterpolationState(){for(let e of this.activeEntities){let t=this.getEntity(e);t&&t._savePreviousState()}}getStateHash(){let t=Array.from(this.activeEntities).sort((o,s)=>o-s).filter(o=>{let s=this.entityTypes.get(o);if(!s)return!0;let r=this.entityDefs.get(s);return!(r?.syncFields&&r.syncFields.length===0)}),n=0;n=Z(n,t.length);for(let o of t){let s=o&1048575,r=this.entityComponents.get(o)||[];n=Z(n,o>>>0);for(let c of r){if(!c.sync)continue;let l=[...c.fieldNames].sort();for(let a of l){let p=c.storage.fields[a][s];n=Z(n,p>>>0)}}}return n>>>0}getStateHashHex(){return this.getStateHash().toString(16).padStart(8,"0")}};var An={};Dt(An,{decode:()=>re,encode:()=>pt});var Bn=class{constructor(){this.buffer=[]}writeByte(e){this.buffer.push(e&255)}writeUint16(e){this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeUint32(e){this.buffer.push(e>>24&255),this.buffer.push(e>>16&255),this.buffer.push(e>>8&255),this.buffer.push(e&255)}writeInt32(e){this.writeUint32(e>>>0)}writeFloat64(e){let t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e,!1);for(let n=0;n<8;n++)this.buffer.push(t.getUint8(n))}writeString(e){let t=new TextEncoder().encode(e);this.writeUint16(t.length);for(let n=0;n<t.length;n++)this.buffer.push(t[n])}writeValue(e){if(e==null)this.writeByte(0);else if(e===!1)this.writeByte(1);else if(e===!0)this.writeByte(2);else if(typeof e=="number")Number.isInteger(e)?e>=0&&e<=255?(this.writeByte(10),this.writeByte(e)):e>=0&&e<=65535?(this.writeByte(11),this.writeUint16(e)):e>=-2147483648&&e<=2147483647?(this.writeByte(5),this.writeInt32(e)):(this.writeByte(6),this.writeFloat64(e)):(this.writeByte(6),this.writeFloat64(e));else if(typeof e=="string")this.writeByte(7),this.writeString(e);else if(Array.isArray(e)){this.writeByte(8),this.writeUint16(e.length);for(let t of e)this.writeValue(t)}else if(typeof e=="object"){this.writeByte(9);let t=Object.keys(e);this.writeUint16(t.length);for(let n of t)this.writeString(n),this.writeValue(e[n])}else this.writeByte(0)}toUint8Array(){return new Uint8Array(this.buffer)}},Rn=class{constructor(e){this.pos=0;this.data=e}readByte(){return this.data[this.pos++]}readUint16(){let e=this.data[this.pos++],t=this.data[this.pos++];return e<<8|t}readUint32(){let e=this.data[this.pos++],t=this.data[this.pos++],n=this.data[this.pos++],o=this.data[this.pos++];return(e<<24|t<<16|n<<8|o)>>>0}readInt32(){let e=this.readUint32();return e>2147483647?e-4294967296:e}readFloat64(){let e=new DataView(new ArrayBuffer(8));for(let t=0;t<8;t++)e.setUint8(t,this.data[this.pos++]);return e.getFloat64(0,!1)}readString(){let e=this.readUint16(),t=this.data.slice(this.pos,this.pos+e);return this.pos+=e,new TextDecoder().decode(t)}readValue(){switch(this.readByte()){case 0:return null;case 1:return!1;case 2:return!0;case 10:return this.readByte();case 11:return this.readUint16();case 5:return this.readInt32();case 12:return this.readUint32();case 6:return this.readFloat64();case 7:return this.readString();case 8:{let t=this.readUint16(),n=[];for(let o=0;o<t;o++)n.push(this.readValue());return n}case 9:{let t=this.readUint16(),n={};for(let o=0;o<t;o++){let s=this.readString();n[s]=this.readValue()}return n}default:return null}}};function pt(i){let e=new Bn;return e.writeValue(i),e.toUint8Array()}function re(i){return new Rn(i).readValue()}function Xt(i,e){let t=Be(),n=new Set;if(i)for(let r of i.entityMeta)n.add(r.eid);let o=[],s=[];for(let r=0;r<e.entityMeta.length;r++){let c=e.entityMeta[r];if(!n.has(c.eid)){let l={};for(let[a,d]of e.componentData){let p=t.get(a);if(!p)continue;let h={},f=0;for(let y of p.fieldNames){let m=p.storage.fields[y],x=m.BYTES_PER_ELEMENT,v=new m.constructor(d,f,e.entityCount);h[y]=v[r],f+=e.entityCount*x}l[a]=h}o.push({eid:c.eid,type:c.type,clientId:c.clientId,components:l})}}if(i){let r=new Set;for(let c of e.entityMeta)r.add(c.eid);for(let c of i.entityMeta)r.has(c.eid)||s.push(c.eid)}return o.sort((r,c)=>r.eid-c.eid),s.sort((r,c)=>r-c),{frame:e.frame,baseHash:i?Ut(i):0,resultHash:Ut(e),created:o,deleted:s}}function Ut(i){let e=Be(),t=0;t=Z(t,i.frame),t=Z(t,i.entityCount);for(let n=0;n<i.entityMeta.length;n++){let o=i.entityMeta[n];t=Z(t,o.eid);for(let[s,r]of i.componentData){let c=e.get(s);if(!c)continue;let l=0;for(let a of c.fieldNames){let d=c.storage.fields[a],p=d.BYTES_PER_ELEMENT,f=new d.constructor(r,l,i.entityCount)[n];t=Z(t,f>>>0),l+=i.entityCount*p}}}return t>>>0}function Ci(i){let e=JSON.stringify(i);return new TextEncoder().encode(e)}function Ei(i){let t=new TextDecoder().decode(i);return JSON.parse(t)}function Wt(i,e,t){let n=i.created.filter(l=>$t(l.eid,t)===e),o=i.deleted.filter(l=>$t(l,t)===e),s={partitionId:e,numPartitions:t,frame:i.frame,created:n,deleted:o},r=JSON.stringify(s);return new TextEncoder().encode(r)}function $t(i,e){return i%e}function Ii(i){let t=new TextDecoder().decode(i);return JSON.parse(t)}function Di(i){if(i.length===0)return null;let e=i[0].frame;for(let o of i)if(o.frame!==e)return console.warn("Partition frame mismatch"),null;let t=[],n=[];for(let o of i)t.push(...o.created),n.push(...o.deleted);return t.sort((o,s)=>o.eid-s.eid),n.sort((o,s)=>o-s),{frame:e,baseHash:0,resultHash:0,created:t,deleted:n}}function Ti(i,e,t){for(let n of i.deleted)t(n);for(let n of i.created)e(n.eid,n.type,n.clientId,n.components);return{created:i.created.map(n=>n.eid),deleted:i.deleted}}function ut(i){return i.created.length===0&&i.deleted.length===0}function Gt(i){let e=16;for(let t of i.created)e+=12,e+=JSON.stringify(t.components).length;return e+=i.deleted.length*4,e}var Pn=65536;function jt(i,e,t,n,o=2){let s=[...e].sort(),r=ht(i,s.length),c=new Map;for(let l=0;l<r;l++){let a=Mn(t,l),d=Nn(s,Math.min(o,s.length),a,n);c.set(l,d)}return{partitionSenders:c,numPartitions:r,frame:t}}function ht(i,e){if(e<=0||i<=0)return 1;let n=Math.ceil(i/30),o=1,s=Math.max(1,e*2);return Math.max(o,Math.min(s,n))}function Mn(i,e){let t=305419896;return t=Z(t,i>>>0),t=Z(t,e>>>0),t>>>0}function Nn(i,e,t,n){if(i.length===0)return[];if(e>=i.length)return[...i];let o=[],s=[...i],r=t;for(let c=0;c<e&&s.length>0;c++){let l=ko(s,n),a=Lo(l,r);o.push(s[a]),s.splice(a,1),r=Ho(r)}return o}function ko(i,e){let t=[];for(let n of i){let o=e[n]??50,r=(Math.max(0,Math.min(100,o))+1)*Pn|0;t.push(r)}return t}function Lo(i,e){if(i.length===0)return-1;if(i.length===1)return 0;let t=0;for(let r of i)t=t+r|0;if(t<=0)return e%i.length;let n=(e>>>0)%Pn,o=zo(n,t),s=0;for(let r=0;r<i.length;r++)if(s=s+i[r]|0,o<s)return r;return i.length-1}function zo(i,e){let t=BigInt(i>>>0)*BigInt(e>>>0)/BigInt(Pn);return Number(t)|0}function Ho(i){let e=i>>>0;return e^=e<<13,e^=e>>>17,e^=e<<5,e>>>0}function wi(i,e,t){return i.partitionSenders.get(t)?.includes(e)??!1}function Kt(i,e){let t=[];for(let[n,o]of i.partitionSenders)o.includes(e)&&t.push(n);return t.sort((n,o)=>n-o)}function Bi(i,e,t,n){return e===i&&t===n?"NORMAL":e>i*.75?"DEGRADED":e>i*.25?"MINIMAL":"SKIP"}var ye=!1,ft=class{constructor(e,t,n){this.game=e;this.typeName=t;this.builder=n}spawn(e={}){return this.game.spawn(this.typeName,e)}},mt=class{constructor(){this.physics=null;this.connection=null;this.callbacks={};this.connectedRoomId=null;this.localClientIdStr=null;this.authorityClientId=null;this.currentFrame=0;this.lastProcessedFrame=0;this.lastInputSeq=0;this.serverFps=20;this.gameLoop=null;this.pendingSnapshotUpload=!1;this.localRoomCreated=!1;this.gameStarted=!1;this.lastSnapshotHash=null;this.lastSnapshotFrame=0;this.lastSnapshotSize=0;this.lastSnapshotEntityCount=0;this.snapshotLoadedFrame=0;this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0};this.lastSyncPercent=100;this.firstDivergenceFrame=null;this.divergenceHistory=[];this.recentInputs=[];this.lastServerSnapshot={raw:null,decoded:null,frame:0};this.lastGoodSnapshot=null;this.divergenceCaptured=!1;this.divergenceCapture=null;this.lastTickTime=0;this.tickIntervalMs=50;this.reliabilityScores={};this.reliabilityVersion=0;this.activeClients=[];this.prevSnapshot=null;this.stateSyncEnabled=!0;this.deltaBytesThisSecond=0;this.deltaBytesPerSecond=0;this.deltaBytesSampleTime=0;this.isDesynced=!1;this.desyncFrame=0;this.desyncLocalHash=0;this.desyncMajorityHash=0;this.resyncPending=!1;this.hashChecksPassed=0;this.hashChecksFailed=0;this.stateHashHistory=new Map;this.HASH_HISTORY_SIZE=10;this.clientIdToNum=new Map;this.numToClientId=new Map;this.nextClientNum=1;this.prefabs=new Map;this.collisionHandlers=new Map;this.clientsWithEntitiesFromSnapshot=new Set;this.clientIdsFromSnapshotMap=new Set;this.clientsWithDisconnectInCatchup=new Set;this.loadedSnapshotSeq=0;this.inCatchupMode=!1;this.renderer=null;this.plugins=new Map;this.world=new qe}addPlugin(e,...t){let n=new e(this,...t),o=e.name||"anonymous";return this.plugins.set(o,n),n}getPlugin(e){return this.plugins.get(e.name)}get frame(){return this.currentFrame}get time(){return this.currentFrame*this.tickIntervalMs}defineEntity(e){return new _n(this,e)}_registerPrefab(e,t){let n=new ft(this,e,t);return this.prefabs.set(e,n),n}spawn(e,t={}){let n={...t};return t.clientId&&typeof t.clientId=="string"&&(n.clientId=this.internClientId(t.clientId)),this.world.spawn(e,n)}getPrefab(e){return this.prefabs.get(e)}query(e){return this.world.query(e)}getEntitiesByType(e){return this.world.query(e).toArray()}getAllEntities(){return this.world.getAllEntities()}getEntityByClientId(e){let t=this.clientIdToNum.get(e);return t===void 0?null:this.world.getEntityByClientId(t)}getPlayer(e){return this.getEntityByClientId(e)}getPlayers(){return this.world.query(te).toArray()}addSystem(e,t){return this.world.addSystem(e,t)}onCollision(e,t,n){if(this.physics)this.physics.onCollision(e,t,n);else{let o=`${e}:${t}`;this.collisionHandlers.set(o,n)}return this}internClientId(e){let t=this.clientIdToNum.get(e);return t===void 0&&(t=this.nextClientNum++,this.clientIdToNum.set(e,t),this.numToClientId.set(t,e)),t}getClientIdNum(e){return this.clientIdToNum.get(e)}getClientIdString(e){return this.numToClientId.get(e)}internString(e,t){return this.world.internString(e,t)}getString(e,t){return this.world.getString(e,t)}getStateHash(){return this.world.getStateHash()}getStateHashHex(){return this.world.getStateHashHex()}reset(){this.world.reset(),this.currentFrame=0}init(e){return this.callbacks={...this.callbacks,...e},this}start(e={}){this.callbacks={...this.callbacks,...e};let t="local-"+Math.random().toString(36).substring(2,10);this.localClientIdStr=t,this.callbacks.onRoomCreate&&this.callbacks.onRoomCreate(),this.localRoomCreated=!0,this.callbacks.onConnect&&this.callbacks.onConnect(t),this.startGameLoop(),this.gameStarted=!0,console.log("[ecs] Started in local/offline mode with clientId:",t)}async connect(e,t,n){let o={},s={};if(t&&("nodeUrl"in t||"centralServiceUrl"in t||"joinToken"in t?s=t:(o=t,s=n||{})),this.callbacks={...this.callbacks,...o},typeof window<"u"){let a=new URLSearchParams(window.location.search);a.get("room")&&(e=a.get("room")),a.get("nodeUrl")&&(s.nodeUrl=a.get("nodeUrl"))}if(this.connectedRoomId=e,this.gameStarted)console.log(`[ecs] Connecting to room "${e}"... (local game will be replaced with server state)`);else{console.log(`[ecs] Starting game locally, connecting to room "${e}" in background...`);let a="local-"+Math.random().toString(36).substring(2,10);this.localClientIdStr=a,this.callbacks.onRoomCreate&&(this.callbacks.onRoomCreate(),this.localRoomCreated=!0),this.gameStarted=!0}this.startGameLoop();let c=typeof window<"u"?window.moduNetwork:void 0;if(!c){console.warn("[ecs] moduNetwork not found - running in offline mode");return}let l=typeof performance<"u"?performance.now():Date.now();try{this.connection=await c.connect(e,{nodeUrl:s.nodeUrl,centralServiceUrl:s.centralServiceUrl,appId:"dev",joinToken:s.joinToken,onConnect:(d,p,h,f,y,m)=>{this.handleConnect(d,p,h,y,m)},onTick:(d,p,h,f,y)=>{this.handleTick(d,p,y)},onDisconnect:()=>{this.handleDisconnect()},onBinarySnapshot:d=>{this.handleServerSnapshot(d)},onError:d=>{console.error("[ecs] Network error:",d)}});let a=(typeof performance<"u"?performance.now():Date.now())-l;console.log(`[ecs] Connected successfully in ${a.toFixed(0)}ms, clientId: ${this.connection.clientId}`),this.localClientIdStr=this.connection.clientId,"onReliabilityUpdate"in this.connection&&(this.connection.onReliabilityUpdate=(d,p)=>{this.handleReliabilityUpdate(d,p)}),"onMajorityHash"in this.connection&&(this.connection.onMajorityHash=(d,p)=>{this.handleMajorityHash(d,p)}),"onResyncSnapshot"in this.connection&&(this.connection.onResyncSnapshot=(d,p)=>{this.handleResyncSnapshot(d,p)})}catch(a){let d=(typeof performance<"u"?performance.now():Date.now())-l;console.error(`[ecs] Connection failed after ${d.toFixed(0)}ms:`,a?.message||a),console.error("[ecs] Make sure the server is running. Check: 1) Central service on port 9001, 2) Node server"),this.connection=null,this.connectedRoomId=null}}handleReliabilityUpdate(e,t){t<=this.reliabilityVersion||(this.reliabilityScores=e,this.reliabilityVersion=t)}handleMajorityHash(e,t){let n=this.stateHashHistory.get(e);if(n===void 0){e%100===0&&console.warn(`[state-sync] No local hash for frame ${e} (history has ${this.stateHashHistory.size} frames)`);return}n===t?(this.hashChecksPassed++,this.isDesynced&&!this.resyncPending&&(console.log(`[state-sync] Recovered from desync at frame ${e}`),this.isDesynced=!1)):(this.hashChecksFailed++,this.resyncPending||(this.isDesynced=!0,this.desyncFrame=e,this.desyncLocalHash=n,this.desyncMajorityHash=t,console.error(`[state-sync] DESYNC DETECTED at frame ${e}`),console.error(`  Local hash:    ${n.toString(16).padStart(8,"0")}`),console.error(`  Majority hash: ${t.toString(16).padStart(8,"0")}`),this.dumpLocalStateForDebug(e),console.error("  Requesting resync from authority..."),this.connection?.requestResync?(this.resyncPending=!0,this.connection.requestResync()):console.warn("[state-sync] Cannot request resync - SDK does not support requestResync()")))}handleResyncSnapshot(e,t){console.warn(`[ENGINE-RESYNC] Received resync snapshot (${e.length} bytes) for frame ${t}. currentFrame=${this.currentFrame} isDesynced=${this.isDesynced}`);let n;try{let c=re(e);n=c?.snapshot,n&&c?.hash!==void 0&&(n.hash=c.hash)}catch{}if(!n)try{let c=new TextDecoder().decode(e),l=JSON.parse(c),a=l?.snapshot;if(a&&typeof a=="object"&&!a.types&&!a.entities){let d=Object.keys(a);if(d.length>0&&d[0]==="0"){let p=new Uint8Array(Object.values(a));try{let h=re(p);n=h?.snapshot,n&&h?.hash!==void 0&&(n.hash=h.hash)}catch{}}}n||(n=a),!n&&l?.types&&l?.entities&&(n=l)}catch{}if(!n){console.error("[state-sync] Failed to decode resync snapshot - no snapshot data (tried binary and JSON)"),this.resyncPending=!1;return}console.error("[state-sync] === DESYNC DIAGNOSIS ==="),console.error(`  Desync detected at frame: ${this.desyncFrame}`),console.error(`  Resync snapshot frame: ${t}`),console.error(`  Local hash at desync:    ${this.desyncLocalHash.toString(16).padStart(8,"0")}`),console.error(`  Majority hash at desync: ${this.desyncMajorityHash.toString(16).padStart(8,"0")}`),this.logDesyncDiff(n,t),console.log("[state-sync] Performing hard recovery...");let o=this.currentFrame;this.loadNetworkSnapshot(n),this.currentFrame=t,this.resyncPending=!1,this.isDesynced=!1;let s=this.world.getStateHash(),r=n.hash;r&&s===r?console.log(`[state-sync] Hard recovery successful - hash=${s.toString(16).padStart(8,"0")}`):r?console.error(`[state-sync] Hard recovery hash mismatch: expected=${r?.toString(16).padStart(8,"0")} got=${s.toString(16).padStart(8,"0")}`):console.log(`[state-sync] Hard recovery completed - hash=${s.toString(16).padStart(8,"0")}`),this.prevSnapshot=this.world.getSparseSnapshot(),this.stateHashHistory.clear(),this.stateHashHistory.set(t,s),this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(n)),frame:t,hash:s},this.clientsWithEntitiesFromSnapshot.clear(),this.clientIdsFromSnapshotMap.clear(),this.clientsWithDisconnectInCatchup.clear(),this.loadedSnapshotSeq=0,console.log("[state-sync] === END RESYNC ===")}dumpLocalStateForDebug(e){console.group(`[DESYNC DEBUG] Local state at frame ${e}`),console.log(`Entity count: ${this.world.getAllEntities().length}`);let t=new Map;for(let o of this.world.getAllEntities())t.has(o.type)||t.set(o.type,[]),t.get(o.type).push(o);console.log("Entity counts by type:");for(let[o,s]of t)console.log(`  ${o}: ${s.length}`);let n=["furniture","player"];for(let o of n){let s=t.get(o)||[];if(s.length!==0){console.group(`${o} entities (first 5):`);for(let r=0;r<Math.min(5,s.length);r++){let c=s[r],l={eid:c.eid};for(let a of c.getComponents()){if(!a.sync)continue;let d=c.eid&65535;for(let p of a.fieldNames){let h=`${a.name}.${p}`;l[h]=a.storage.fields[p][d]}}console.log(`  [${r}]`,JSON.stringify(l))}console.groupEnd()}}console.groupEnd()}logDesyncDiff(e,t){let n=[],o=[],s=e.types||[],r=e.entities||[],c=e.schema||[],l=new Map;for(let m of r)l.set(m[0],m);let a=0,d=0;for(let m of this.world.getAllEntities()){let x=m.eid,v=l.get(x),E=x&1048575;if(!v){for(let A of m.getComponents()){d+=A.fieldNames.length;for(let N of A.fieldNames)o.push({entity:m.type,eid:x,comp:A.name,field:N,local:"EXISTS",server:"MISSING"})}continue}let[,F,b]=v,D=c[F];if(!D)continue;let M=0;for(let[A,N]of D){let q=m.getComponents().find(U=>U.name===A);for(let U of N){d++;let Q=b[M++];if(q){let T=q.storage.fields[U][E],P=q.schema[U],Y=!1;P?.type==="bool"?Y=T!==0===(Q!==0&&Q!==!1):Y=T===Q,Y?a++:o.push({entity:m.type,eid:x,comp:A,field:U,local:T,server:Q})}}}}for(let[m,x]of l)if(this.world.getEntity(m)===null){let[,v,E]=x,F=s[v]||`type${v}`;d+=E.length,o.push({entity:F,eid:m,comp:"*",field:"*",local:"MISSING",server:"EXISTS"})}let p=d>0?a/d*100:100;n.push(`DIVERGENT FIELDS: ${o.length} differences found`),n.push(`  Sync: ${p.toFixed(1)}% (${a}/${d} fields match)`),n.push("");let h=new Map;for(let m of this.world.getAllEntities())if(m.has(te)){let x=m.get(te),v=this.numToClientId.get(x.clientId);v&&h.set(m.eid,v.slice(0,8))}let f=new Map;for(let m of o)f.has(m.eid)||f.set(m.eid,[]),f.get(m.eid).push(m);for(let[m,x]of f){let v=x[0],E=h.get(m),F=E?` [owner: ${E}]`:"";n.push(`  ${v.entity}#${m.toString(16)}${F}:`);for(let b of x){let D=typeof b.local=="number"&&typeof b.server=="number"?` (\u0394 ${(b.local-b.server).toFixed(4)})`:"";n.push(`    ${b.comp}.${b.field}: local=${b.local} server=${b.server}${D}`)}}o.length===0&&n.push("  No field differences found (hash mismatch may be due to RNG or string state)");let y=Math.min(this.recentInputs.length,20);if(y>0){n.push(""),n.push(`RECENT INPUTS (last ${y}):`);let m=this.recentInputs.slice(-y);for(let x of m){let v=x.clientId.slice(0,8);n.push(`  f${x.frame} [${v}]: ${JSON.stringify(x.data)}`)}}console.error(n.join(`
`))}handleConnect(e,t,n,o,s){let r=0;if(e instanceof Uint8Array)if(r=e.length,e.length<2)e=null;else try{let l=re(e);e=l?.snapshot||null,e&&l?.hash!==void 0&&(e.hash=l.hash)}catch(l){console.error("[ecs] Failed to decode snapshot:",l),e=null}if(this.localClientIdStr=s,this.serverFps=o,this.tickIntervalMs=1e3/o,this.currentFrame=n,e?.hash!==void 0&&(this.lastSnapshotHash=typeof e.hash=="number"?e.hash:parseInt(String(e.hash),16)||0,this.lastSnapshotFrame=e.frame||n,this.lastSnapshotSize=r,this.lastSnapshotEntityCount=e.entities?.length||0),ye&&(console.log(`[ecs] Connected as ${s}, frame ${n}, fps ${o}`),console.log("[ecs] Snapshot:",e?{frame:e.frame,entityCount:e.entities?.length}:"none"),console.log(`[ecs] Inputs: ${t.length}`)),e?.entities&&e.entities.length>0){let l=e.seq||0;for(let F of t){if(F.seq===void 0||F.seq>l)continue;let b=F.data;if(b instanceof Uint8Array)try{b=re(b)}catch{continue}let D=b?.clientId||F.clientId;D&&(b?.type==="join"||b?.type==="reconnect")&&this.internClientId(D)}this.currentFrame=e.frame||n,this.loadNetworkSnapshot(e);let a=this.world.getStateHash(),d=e.hash;d!==void 0&&a!==d&&console.error(`[SNAPSHOT] HASH MISMATCH! loaded=0x${a.toString(16)} expected=0x${d?.toString(16)}`);let p=he();this.callbacks.onSnapshot&&this.callbacks.onSnapshot(this.world.getAllEntities()),fe(p);let h=F=>{let b=F.data;if(b instanceof Uint8Array)try{b=re(b)}catch{return}return b?.type},f=t.filter(F=>{let b=h(F);return b==="join"||b==="reconnect"||b==="disconnect"||b==="leave"?!0:F.seq>l}).sort((F,b)=>F.seq-b.seq);this.loadedSnapshotSeq=l;for(let F of f){let b=h(F);b==="disconnect"||b==="leave"?this.processInput(F):(b==="join"||b==="reconnect")&&(F.seq||0)>l&&this.processInput(F)}let y=this.currentFrame,x=e.postTick===!0?y+1:y,v=n-x+1,E=200;if(v>E){console.warn(`[CATCHUP] Too many frames to catch up (${v} > ${E}). Requesting fresh snapshot.`),this.connection?.requestResync&&this.connection.requestResync(),this.currentFrame=n,this.lastProcessedFrame=n,this.prevSnapshot=this.world.getSparseSnapshot(),this.startGameLoop();return}v>0&&this.runCatchup(x,n,f),this.snapshotLoadedFrame=this.currentFrame,this.prevSnapshot=this.world.getSparseSnapshot(),this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:this.currentFrame,hash:this.getStateHash()}}else{ye&&console.log("[ecs] First join: creating room"),this.currentFrame=n,this.authorityClientId=s,this.activeClients.includes(s)||(this.activeClients.push(s),this.activeClients.sort()),this.localRoomCreated?(console.log("[ecs] Local-first handoff: flushing local state, recreating with server identity"),this.world.reset(),this.physics&&this.physics.clear(),this.clientIdToNum.clear(),this.numToClientId.clear(),this.nextClientNum=1,this.activeClients=[s],this.stateHashHistory.clear(),this.localRoomCreated=!1,this.callbacks.onRoomCreate?.(),this.localRoomCreated=!0):this.callbacks.onRoomCreate?.();for(let a of t)this.processInput(a);this.world.tick(n,[]),this.lastProcessedFrame=n;let l=this.world.getStateHash();this.stateHashHistory.set(n,l)}this.checkIsAuthority()&&this.sendSnapshot("init"),this.startGameLoop(),console.log("[ecs] Game loop started, waiting for server TICK messages...")}handleTick(e,t,n){if(e<=this.lastProcessedFrame){ye&&console.log(`[ecs] Skipping old frame ${e} (already at ${this.lastProcessedFrame})`);return}if(this.currentFrame=e,this.lastProcessedFrame=e,ye&&t.length>0){let r=t.map(c=>c.data?.type||"game").join(",");console.log(`[ecs] onTick frame=${e}: ${t.length} inputs (${r})`)}let o=t.length>1?[...t].sort((r,c)=>(r.seq||0)-(c.seq||0)):t;for(let r of o)this.processInput(r);this.world.tick(e,[]);let s=this.world.getStateHash();if(this.callbacks.onTick?.(e),this.pendingSnapshotUpload&&this.checkIsAuthority()&&(this.sendSnapshot("join"),this.pendingSnapshotUpload=!1),this.lastTickTime=typeof performance<"u"?performance.now():Date.now(),n!==void 0&&n!==0){let r=e-1;this.handleMajorityHash(r,n)}else this.activeClients.length>1&&e%100===0&&console.warn(`[state-sync] No majorityHash in tick ${e} (expected with ${this.activeClients.length} clients)`);this.sendStateSync(e)}sendStateSync(e){if(!this.stateSyncEnabled||!this.connection?.sendStateHash)return;let t=typeof performance<"u"?performance.now():Date.now();t-this.deltaBytesSampleTime>=1e3&&(this.deltaBytesPerSecond=this.deltaBytesThisSecond,this.deltaBytesThisSecond=0,this.deltaBytesSampleTime=t);let n=this.world.getStateHash();if(this.connection.sendStateHash(e,n),this.deltaBytesThisSecond+=9,this.stateHashHistory.set(e,n),this.stateHashHistory.size>this.HASH_HISTORY_SIZE){let s=e-this.HASH_HISTORY_SIZE;for(let r of this.stateHashHistory.keys())r<=s&&this.stateHashHistory.delete(r)}let o=this.world.getSparseSnapshot();if(this.activeClients.length>1&&this.connection.clientId&&this.connection.sendPartitionData&&this.prevSnapshot){let s=Xt(this.prevSnapshot,o),r=Gt(s);if(e%60===0&&!ut(s)&&console.log(`[delta] frame=${e} created=${s.created.length} deleted=${s.deleted.length} bytes=${r}`),!ut(s)){let c=this.world.entityCount,l=ht(c,this.activeClients.length),a=jt(c,this.activeClients,e,this.reliabilityScores),d=Kt(a,this.connection.clientId);for(let p of d)if(s.created.some(f=>f.eid%l===p)||s.deleted.some(f=>f%l===p)){let f=Wt(s,p,l);this.connection.sendPartitionData(e,p,f),this.deltaBytesThisSecond+=8+f.length}}}this.prevSnapshot=o}processInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=re(t)}catch(s){console.warn("[ecs] Failed to decode input:",s);return}let n=t?.clientId||e.clientId,o=t?.type;if(this.recentInputs.push({frame:this.currentFrame,seq:e.seq,clientId:n,data:JSON.parse(JSON.stringify(t))}),this.recentInputs.length>500&&this.recentInputs.shift(),e.seq>this.lastInputSeq&&(this.lastInputSeq=e.seq),o==="join"){let s=e.seq||0;if(this.inCatchupMode&&s>0&&s<=this.loadedSnapshotSeq){console.warn(`[ecs] Stale JOIN filtered (seq ${s} <= snapshotSeq ${this.loadedSnapshotSeq}): ${n.slice(0,8)}`);return}this.activeClients.includes(n)||(this.activeClients.push(n),this.activeClients.sort()),this.authorityClientId===null&&(this.authorityClientId=n);let l=he();this.callbacks.onConnect?.(n),fe(l),this.checkIsAuthority()&&(this.pendingSnapshotUpload=!0)}else if(o==="resync_request")this.checkIsAuthority()&&(this.pendingSnapshotUpload=!0);else if(o==="leave"||o==="disconnect"){let s=this.activeClients.indexOf(n);s!==-1&&this.activeClients.splice(s,1),n===this.authorityClientId&&(this.authorityClientId=this.activeClients[0]||null),this.clientsWithEntitiesFromSnapshot.delete(n);let r=he();this.callbacks.onDisconnect?.(n),fe(r),this.checkIsAuthority()&&(this.pendingSnapshotUpload=!0)}else t&&this.routeInputToEntity(n,t)}routeInputToEntity(e,t){let n=this.internClientId(e);if(this.world.setInput(n,t),ye){let o=this.world.getEntityByClientId(n);console.log(`[ecs] routeInput: clientId=${e.slice(0,8)}, numId=${n}, entity=${o?.eid||"null"}, data=${JSON.stringify(t)}`)}}processAuthorityChainInput(e){let t=e.data;if(t instanceof Uint8Array)try{t=re(t)}catch{return}let n=t?.clientId||e.clientId,o=t?.type;if(o==="join")this.activeClients.includes(n)||(this.activeClients.push(n),this.activeClients.sort()),this.authorityClientId===null&&(this.authorityClientId=n);else if(o==="leave"||o==="disconnect"){let s=this.activeClients.indexOf(n);s!==-1&&this.activeClients.splice(s,1),n===this.authorityClientId&&(this.authorityClientId=this.activeClients[0]||null)}}runCatchup(e,t,n){let o=t-e+1,s=[...n].sort((c,l)=>(c.seq||0)-(l.seq||0)),r=new Map;for(let c of s){if(c.frame===void 0||c.frame===null)continue;let l=c.frame;if(l>t)continue;let a=Math.max(l,e);r.has(a)||r.set(a,[]),r.get(a).push(c)}this.stateHashHistory.clear(),this.inCatchupMode=!0;for(let c=0;c<o;c++){let l=e+c;this.currentFrame=l;let a=r.get(l)||[];for(let p of a)this.processInput(p);this.world.tick(l,[]);let d=this.world.getStateHash();this.callbacks.onTick?.(l),this.stateHashHistory.set(l,d)}this.currentFrame=t,this.lastProcessedFrame=t,this.clientsWithEntitiesFromSnapshot.clear(),this.clientIdsFromSnapshotMap.clear(),this.clientsWithDisconnectInCatchup.clear(),this.loadedSnapshotSeq=0,this.inCatchupMode=!1}getNetworkSnapshot(){let e=[],t=new Map,n=[],o=new Map,s=[];for(let c of this.world.getAllEntities()){let l=c.eid&1048575,a=c.type,d=this.world.getEntityDef(a);if(d?.syncFields&&d.syncFields.length===0)continue;if(!t.has(a)){let f=e.length;e.push(a),t.set(a,f);let y=d?.syncFields?new Set(d.syncFields):null;o.set(a,y);let m=[];for(let x of c.getComponents()){let v=y?x.fieldNames.filter(E=>y.has(E)):x.fieldNames;v.length>0&&m.push([x.name,v])}n.push(m)}let p=o.get(a),h=[];for(let f of c.getComponents())for(let y of f.fieldNames)(!p||p.has(y))&&h.push(f.storage.fields[y][l]);s.push([c.eid,t.get(a),h])}let r=this.world.idAllocator.getState();return{frame:this.currentFrame,seq:this.lastInputSeq,postTick:!0,format:5,types:e,schema:n,entities:s,idAllocatorState:r,rng:he(),strings:this.world.strings.getState(),clientIdMap:{toNum:Object.fromEntries(this.clientIdToNum),nextNum:this.nextClientNum},inputState:this.world.getInputState()}}loadNetworkSnapshot(e){if(ye&&console.log(`[ecs] Loading snapshot: ${e.entities?.length} entities`),this.loadedSnapshotSeq=e.seq||0,this.world.reset(),this.physics&&this.physics.clear(),e.rng&&fe(e.rng),e.strings&&this.world.strings.setState(e.strings),e.clientIdMap){let c=Object.entries(e.clientIdMap.toNum);this.clientIdsFromSnapshotMap.clear();for(let[a]of c)this.clientIdsFromSnapshotMap.add(a);let l=[];for(let[a,d]of this.clientIdToNum.entries())c.some(([h])=>h===a)||l.push([a,d]);this.clientIdToNum=new Map(c.map(([a,d])=>[a,d])),this.numToClientId=new Map(c.map(([a,d])=>[d,a])),this.nextClientNum=e.clientIdMap.nextNum||1;for(let[a]of l){let d=this.nextClientNum++;this.clientIdToNum.set(a,d),this.numToClientId.set(d,a)}}let t=e.types,n=e.schema,o=e.entities,s=new Map;for(let c of o){let[l,a,d]=c,p=t[a],h=n[a],f;try{f=this.world.spawnWithId(p,l,{})}catch(x){console.warn(`[ecs] Failed to spawn ${p} with eid ${l}:`,x);continue}s.has(p)||s.set(p,[]),s.get(p).push(f);let y=l&1048575,m=0;for(let[x,v]of h)for(let E of f.getComponents())if(E.name===x){for(let F of v)E.storage.fields[F][y]=d[m++];break}if(f.has(te)){let x=f.get(te);x.clientId!==0&&this.world.setEntityClientId(f.eid,x.clientId)}}for(let[c,l]of s){let a=this.world.getEntityDef(c);if(a?.onRestore)for(let d of l)a.onRestore(d,this)}if(this.lastInputSeq=e.seq||0,e.idAllocatorState){let c=e.idAllocatorState;if(this.world.idAllocator.reset(),this.world.idAllocator.setNextId(c.nextIndex),Array.isArray(c.generations))for(let d=0;d<c.generations.length;d++)this.world.idAllocator.generations[d]=c.generations[d];else if(typeof c.generations=="object")for(let[d,p]of Object.entries(c.generations)){let h=parseInt(d,10);this.world.idAllocator.generations[h]=p}let l=new Set;for(let d of this.world.getAllEntities())d.eid&lt||l.add(d.eid&1048575);let a=[];for(let d=0;d<c.nextIndex;d++)l.has(d)||a.push(d);this.world.idAllocator.freeList=a}this.clientsWithEntitiesFromSnapshot.clear(),this.activeClients.length=0;let r=typeof window<"u"?window.moduNetwork:void 0;for(let c of this.world.query(te)){let l=c.get(te);if(l.clientId===0){console.error(`[ecs] Player entity ${c.eid} has clientId=0 (invalid)`);continue}let a=this.getClientIdString(l.clientId);a&&(this.clientsWithEntitiesFromSnapshot.add(a),this.activeClients.includes(a)||this.activeClients.push(a),r?.registerClientId&&(r.registerClientId(a),ye&&console.log(`[ecs] Registered clientId ${a.slice(0,8)} from snapshot entity`)),ye&&console.log(`[ecs] Snapshot has entity for client ${a.slice(0,8)}`))}if(this.activeClients.sort(),this.physics&&this.physics.syncAllFromComponents(),e.inputState){this.world.setInputState(e.inputState);let c=this.world.getInputState(),l=Object.keys(e.inputState).sort().join(","),a=Object.keys(c).sort().join(",");l!==a&&console.error(`[INPUT-STATE] KEYS DIFFER! snapshot=[${l}] loaded=[${a}]`)}}sendSnapshot(e){if(!this.connection)return;this.physics&&this.physics.wakeAllBodies();let t=this.getNetworkSnapshot(),n=this.world.getStateHash(),o=pt({snapshot:t,hash:n}),s=t.entities.length;this.connection.sendSnapshot(o,n,t.seq,t.frame),this.lastSnapshotHash=n,this.lastSnapshotFrame=t.frame,this.lastSnapshotSize=o.length,this.lastSnapshotEntityCount=s}handleServerSnapshot(e){ye&&console.log(`[ecs] Received server snapshot: ${e.length} bytes`);try{let t=re(e),n=t?.snapshot,o=t?.hash;if(n)if(this.lastSnapshotHash=typeof o=="number"?o:(o?parseInt(String(o),16):null)||null,this.lastSnapshotFrame=n.frame,this.lastSnapshotSize=e.length,this.lastSnapshotEntityCount=n.entities?.length||0,this.currentFrame===n.frame){this.compareSnapshotFields(n);let s=this.getStateHash();s!==o&&console.warn(`[ecs] DRIFT detected at frame ${n.frame}: local=${s}, server=${o}`)}else this.driftStats={determinismPercent:100,totalChecks:0,matchingFieldCount:0,totalFieldCount:0}}catch(t){console.warn("[ecs] Failed to decode server snapshot:",t)}}compareSnapshotFields(e){let t=e.frame,n=0,o=0,s=[];this.lastServerSnapshot={raw:null,decoded:e,frame:t};let r=e.types||[],c=e.entities||[],l=e.schema||[],a=new Map;for(let f of c)a.set(f[0],f);for(let f of this.world.getAllEntities()){let y=f.eid,m=a.get(y),x=y&1048575;if(!m){for(let D of f.getComponents()){o+=D.fieldNames.length;for(let M of D.fieldNames)s.push({entity:f.type,eid:y,comp:D.name,field:M,local:"EXISTS",server:"MISSING"})}continue}let[,v,E]=m,F=l[v];if(!F)continue;let b=0;for(let[D,M]of F){let A=f.getComponents().find(N=>N.name===D);for(let N of M){o++;let q=E[b++];if(A){let U=A.storage.fields[N][x],Q=A.schema[N],T=!1;Q?.type==="bool"?T=U!==0===(q!==0&&q!==!1):T=U===q,T?n++:s.push({entity:f.type,eid:y,comp:D,field:N,local:U,server:q})}}}}for(let[f,y]of a)if(this.world.getEntity(f)===null){let[,m,x]=y,v=r[m]||`type${m}`;o+=x.length,s.push({entity:v,eid:f,comp:"*",field:"*",local:"MISSING",server:"EXISTS"})}let d=o>0?n/o*100:100,p=this.lastSyncPercent===100,h=d===100;if(h&&(this.lastGoodSnapshot={snapshot:JSON.parse(JSON.stringify(e)),frame:t,hash:this.getStateHash()}),p&&!h&&!this.divergenceCaptured){this.firstDivergenceFrame=t,this.divergenceHistory=[],this.divergenceCaptured=!0;let f=this.lastGoodSnapshot?.frame??0,y=this.recentInputs.filter(x=>x.frame>f&&x.frame<=t),m=this.world.getState();this.divergenceCapture={lastGoodSnapshot:this.lastGoodSnapshot?.snapshot??null,lastGoodFrame:f,inputs:y,localSnapshot:m,serverSnapshot:e,diffs:s,divergenceFrame:t,clientId:this.localClientIdStr,isAuthority:this.checkIsAuthority()},this.showDivergenceDiff(s,y,t)}this.lastSyncPercent=d,this.driftStats.totalChecks++,this.driftStats.matchingFieldCount=n,this.driftStats.totalFieldCount=o,this.driftStats.determinismPercent=d,s.length>0&&d<100&&this.divergenceCaptured&&t%60===0&&console.warn(`[DIVERGENCE] Frame ${t}: still diverged (${d.toFixed(1)}% sync, first at ${this.firstDivergenceFrame})`)}showDivergenceDiff(e,t,n){let o=[],s=this.lastGoodSnapshot?.frame??0,r=this.localClientIdStr||"",c=new Set;for(let p of t)c.add(p.clientId);let l=Array.from(c),a=new Map;l.forEach((p,h)=>{let f=p===r?"ME":`P${h+1}`;a.set(p,f)});let d=new Map;for(let p of this.world.getAllEntities())if(p.has(te)){let h=p.get(te),f=this.numToClientId.get(h.clientId);f&&d.set(p.eid,a.get(f)||f.slice(0,8))}o.push("=== DIVERGENCE DEBUG DATA ==="),o.push(`Frame: ${n} | Last good: ${s} | Authority: ${this.checkIsAuthority()}`),o.push(`Clients: ${l.map(p=>`${a.get(p)}=${p.slice(0,8)}`).join(", ")}`),o.push(""),o.push(`DIVERGENT FIELDS (${e.length}):`);for(let p of e){let h=typeof p.local=="number"&&typeof p.server=="number"?` \u0394${p.local-p.server}`:"",f=d.get(p.eid),y=f?` [${f}]`:"";o.push(`  ${p.entity}#${p.eid.toString(16)}${y}.${p.comp}.${p.field}: local=${p.local} server=${p.server}${h}`)}o.push(""),o.push(`INPUTS (${t.length}):`);for(let p of t){let h=a.get(p.clientId)||p.clientId.slice(0,8);o.push(`  f${p.frame} [${h}]: ${JSON.stringify(p.data)}`)}if(o.push(""),this.lastGoodSnapshot){let p=Object.keys(this.lastGoodSnapshot.snapshot.entities||{}).length;o.push(`LAST GOOD SNAPSHOT (f${s}): ${p} entities`)}else o.push("LAST GOOD SNAPSHOT: none (never had 100% sync)");if(this.lastServerSnapshot.decoded){let p=Object.keys(this.lastServerSnapshot.decoded.entities||{}).length;o.push(`SERVER SNAPSHOT (f${this.lastServerSnapshot.frame}): ${p} entities`)}o.push("=== END DEBUG DATA ==="),o.push("To get detailed replay data: game.getDivergenceReplay()"),console.error(o.join(`
`))}getDivergenceReplay(){if(!this.divergenceCapture){console.warn("[REPLAY] No divergence captured yet.");return}let e=JSON.stringify(this.divergenceCapture,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`divergence-${this.divergenceCapture.divergenceFrame}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log(`[REPLAY] Downloaded (${(e.length/1024).toFixed(1)} KB)`)}startGameLoop(){if(this.gameLoop)return;let e=typeof performance<"u"?performance.now():Date.now(),t=()=>{let n=typeof performance<"u"?performance.now():Date.now();if(!this.connection)for(;n-e>=this.tickIntervalMs;)this.currentFrame++,this.world.tick(this.currentFrame,[]),this.callbacks.onTick?.(this.currentFrame),e+=this.tickIntervalMs;this.renderer?.render?this.renderer.render():this.callbacks.render&&this.callbacks.render(),this.gameLoop=requestAnimationFrame(t)};this.gameLoop=requestAnimationFrame(t)}stopGameLoop(){this.gameLoop&&(cancelAnimationFrame(this.gameLoop),this.gameLoop=null)}handleDisconnect(){console.log("[ecs] Disconnected from server");let e=this.connection!==null;this.connection=null,e&&this.callbacks.onDisconnect&&this.callbacks.onDisconnect(void 0)}checkIsAuthority(){if(this.localClientIdStr===null||this.authorityClientId===null)return!1;let e=Math.min(this.localClientIdStr.length,this.authorityClientId.length);return this.localClientIdStr.substring(0,e)===this.authorityClientId.substring(0,e)}isAuthority(){return this.checkIsAuthority()}isConnected(){return this.connection!==null}isStarted(){return this.gameStarted}getFrame(){return this.currentFrame}getServerFps(){return this.serverFps}getRenderAlpha(){if(this.lastTickTime===0)return 1;let t=(typeof performance<"u"?performance.now():Date.now())-this.lastTickTime;return Math.min(t/this.tickIntervalMs,1)}sendInput(e){if(!this.connection)return;let t=pt(e);this.connection.send(t)}leaveRoom(){this.connection&&(this.connection.leaveRoom(),this.connection=null),this.stopGameLoop()}stop(){this.stopGameLoop(),console.log("[ecs] Game stopped")}get localClientId(){return this.localClientIdStr}setLocalClientId(e){this.localClientIdStr=e;let t=this.internClientId(e);this.world.localClientId=t}getRoomId(){return this.connectedRoomId}getLastSnapshot(){return{hash:this.lastSnapshotHash,frame:this.lastSnapshotFrame,size:this.lastSnapshotSize,entityCount:this.lastSnapshotEntityCount}}getClients(){return this.activeClients}getClientId(){return this.localClientIdStr}getNodeUrl(){return null}getUploadRate(){return this.connection?.bandwidthOut||0}getDownloadRate(){return this.connection?.bandwidthIn||0}getDriftStats(){if(this.driftStats.totalChecks===0){let e=this.world.getAllEntities().length,t=0;for(let n of this.world.getAllEntities())for(let o of n.getComponents())t+=o.fieldNames.length;return{determinismPercent:100,totalChecks:0,matchingFieldCount:t,totalFieldCount:t}}return{...this.driftStats}}getSyncStats(){let e=this.hashChecksPassed+this.hashChecksFailed;return{syncPercent:e>0?this.hashChecksPassed/e*100:100,passed:this.hashChecksPassed,failed:this.hashChecksFailed,isDesynced:this.isDesynced,resyncPending:this.resyncPending}}setRenderer(e){this.renderer=e}getCanvas(){return this.renderer?.element??null}getReliabilityScores(){return{...this.reliabilityScores}}getActiveClients(){return[...this.activeClients]}getEntityCount(){return this.world.entityCount}getDeltaBandwidth(){return this.deltaBytesPerSecond}},_n=class{constructor(e,t){this.game=e;this.name=t;this.inputCommandsDef=null;this.worldBuilder=e.world.defineEntity(t)}with(e,t){return this.worldBuilder.with(e,t),this}commands(e){return this.inputCommandsDef=e,this}syncOnly(e){return this.worldBuilder._setSyncFields(e),this}syncNone(){return this.worldBuilder._setSyncFields([]),this}sync(e){return this.syncOnly(e)}onRestore(e){return this.worldBuilder._setOnRestore(e),this}register(){return this.worldBuilder._ensureRegistered(),this.game._registerPrefab(this.name,this.worldBuilder)}};function Ri(){return console.log("[MODU] Engine version: BUILD_50"),new mt}var yt=class{constructor(e,t,n={}){this.imageCache=new Map;this._cameraEntity=null;if(this.game=e,typeof t=="string"){let s=document.querySelector(t);if(!s)throw new Error(`Canvas not found: ${t}`);this.canvas=s}else this.canvas=t;let o=this.canvas.getContext("2d");if(!o)throw new Error("Could not get 2d context");this.ctx=o,this.options={background:n.background??"#111",autoClear:n.autoClear??!0},e.setRenderer(this)}get width(){return this.canvas.width}get height(){return this.canvas.height}get element(){return this.canvas}get context(){return this.ctx}set camera(e){if(this._cameraEntity=e,e)try{let t=e.get(J);t.viewportWidth=this.canvas.width,t.viewportHeight=this.canvas.height}catch{}}get camera(){return this._cameraEntity}render(){let{ctx:e,canvas:t,options:n,game:o}=this;n.autoClear&&(e.fillStyle=n.background,e.fillRect(0,0,t.width,t.height));let s=o.getRenderAlpha(),r=0,c=0,l=1;if(this._cameraEntity&&!this._cameraEntity.destroyed)try{let d=this._cameraEntity.get(J);r=d.x,c=d.y,l=d.zoom,d.viewportWidth=t.width,d.viewportHeight=t.height}catch{}let a=[];for(let d of o.getAllEntities())if(!d.destroyed)try{let p=d.get(ot);p&&p.visible&&(d.interpolate(s),a.push({entity:d,layer:p.layer}))}catch{}a.sort((d,p)=>d.layer-p.layer),e.save(),e.translate(t.width/2,t.height/2),e.scale(l,l),e.translate(-r,-c);for(let{entity:d}of a)this.drawEntity(d);e.restore()}drawEntity(e){let{ctx:t,game:n}=this,o=e.get(ot),s=e.render.interpX+o.offsetX,r=e.render.interpY+o.offsetY,c=o.scaleX,l=o.scaleY,a=n.getString("color",o.color)||"#fff";t.save(),t.translate(s,r),t.scale(c,l);let d=o.shape;if(d===ze){let p=o.radius;t.fillStyle=a,t.beginPath(),t.arc(0,0,p,0,Math.PI*2),t.fill()}else if(d===Ht){let p=o.width,h=o.height;t.fillStyle=a,t.fillRect(-p/2,-h/2,p,h)}else if(d===zt){let p=n.getString("sprite",o.spriteId);if(p){let h=this.getImage(p);if(h&&h.complete){let f=o.width||h.width,y=o.height||h.height;t.drawImage(h,-f/2,-y/2,f,y)}}}t.restore()}getImage(e){let t=this.imageCache.get(e);return t||(t=new Image,t.src=e,this.imageCache.set(e,t)),t}preload(e){return Promise.all(e.map(t=>new Promise(n=>{let o=this.getImage(t);o?.complete?n():o&&(o.onload=()=>n(),o.onerror=()=>n())}))).then(()=>{})}};var Zt=class{constructor(e,t){this.actions=new Map;this.bindings=new Map;this.mousePos={x:0,y:0};this.keysDown=new Set;this.mouseButtons=new Set;this.sendInterval=null;if(this.game=e,typeof t=="string"){let n=document.querySelector(t);if(!n)throw new Error(`Canvas not found: ${t}`);this.canvas=n}else this.canvas=t;this.setupListeners(),this.startSendLoop()}action(e,t){return this.actions.set(e,t),this.bindings.has(e)||this.bindings.set(e,[...t.bindings]),this}rebind(e,t){return this.actions.has(e)?(this.bindings.set(e,t),this):(console.warn(`[InputPlugin] Unknown action: ${e}`),this)}resetBinding(e){let t=this.actions.get(e);return t&&this.bindings.set(e,[...t.bindings]),this}resetAllBindings(){for(let[e,t]of this.actions)this.bindings.set(e,[...t.bindings]);return this}getBindings(){let e={};for(let[t,n]of this.bindings)e[t]=n.filter(o=>typeof o=="string");return e}loadBindings(e){for(let[t,n]of Object.entries(e))this.actions.has(t)&&this.bindings.set(t,n);return this}isKeyDown(e){return this.keysDown.has(e.toLowerCase())}get(e){let t=this.actions.get(e),n=this.bindings.get(e);return!t||!n?null:t.type==="button"?this.resolveButton(n):this.resolveVector(n)}getAll(){let e={};for(let t of this.actions.keys())e[t]=this.get(t);return e}resolveButton(e){for(let t of e)if(typeof t=="function"){if(t())return!0}else if(this.resolveStringButton(t))return!0;return!1}resolveVector(e){let t=0,n=0;for(let o of e){let s=null;typeof o=="function"?s=o():s=this.resolveStringVector(o),s&&(t+=s.x,n+=s.y)}return{x:t,y:n}}resolveStringButton(e){if(e.startsWith("key:")){let t=e.slice(4).toLowerCase();return this.keysDown.has(t)}if(e.startsWith("mouse:")){let t=e.slice(6);if(t==="left")return this.mouseButtons.has(0);if(t==="right")return this.mouseButtons.has(2);if(t==="middle")return this.mouseButtons.has(1)}return!1}resolveStringVector(e){return e==="mouse"?{...this.mousePos}:null}getMousePos(){return{...this.mousePos}}isMouseButtonDown(e){return this.mouseButtons.has(e)}setupListeners(){this.canvas.addEventListener("mousemove",e=>{let t=this.canvas.getBoundingClientRect();this.mousePos.x=e.clientX-t.left,this.mousePos.y=e.clientY-t.top}),this.canvas.addEventListener("mousedown",e=>{this.mouseButtons.add(e.button)}),this.canvas.addEventListener("mouseup",e=>{this.mouseButtons.delete(e.button)}),window.addEventListener("keydown",e=>{this.keysDown.add(e.key.toLowerCase())}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key.toLowerCase())}),window.addEventListener("blur",()=>{this.keysDown.clear(),this.mouseButtons.clear()})}startSendLoop(){let e=1e3/(this.game.getServerFps?.()||20);this.sendInterval=window.setInterval(()=>{if(this.game.isConnected()&&this.game.localClientId&&this.actions.size>0){let t=this.getAll();this.game.sendInput(t)}},e)}destroy(){this.sendInterval!==null&&(clearInterval(this.sendInterval),this.sendInterval=null)}};var Qt=class{constructor(e,t={}){this.game=e,this.options={defaultZoom:t.defaultZoom??1,defaultSmoothing:t.defaultSmoothing??.1,minZoom:t.minZoom??.1,maxZoom:t.maxZoom??10},e.addSystem(this.update.bind(this),{phase:"render"})}update(){for(let e of this.game.query("Camera2D"))this.updateCamera(e)}updateCamera(e){let t=e.get(J);if(t.followEntity!==0){let n=this.game.world.getEntity(t.followEntity);if(n&&!n.destroyed)try{let o=n.get(O);t.x+=(o.x-t.x)*t.smoothing,t.y+=(o.y-t.y)*t.smoothing}catch{}}t.zoom!==t.targetZoom&&(t.zoom+=(t.targetZoom-t.zoom)*t.smoothing,t.zoom=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t.zoom)))}follow(e,t){let n=e.get(J);n.followEntity=t?t.eid:0}centerOn(e,t,n){if(t.length===0)return;let o=e.get(J),s=0,r=0,c=0;for(let l=0;l<t.length;l++){let a=t[l];if(!a.destroyed)try{let d=a.get(O),p=n?.[l]??1;r+=d.x*p,c+=d.y*p,s+=p}catch{}}s>0&&(o.x+=(r/s-o.x)*o.smoothing,o.y+=(c/s-o.y)*o.smoothing)}worldToScreen(e,t,n){let o=e.get(J);return{x:(t-o.x)*o.zoom+o.viewportWidth/2,y:(n-o.y)*o.zoom+o.viewportHeight/2}}screenToWorld(e,t,n){let o=e.get(J);return{x:(t-o.viewportWidth/2)/o.zoom+o.x,y:(n-o.viewportHeight/2)/o.zoom+o.y}}setZoom(e,t,n=!1){let o=e.get(J),s=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,t));o.targetZoom=s,n&&(o.zoom=s)}getVisibleBounds(e){let t=e.get(J),n=t.viewportWidth/2/t.zoom,o=t.viewportHeight/2/t.zoom;return{left:t.x-n,top:t.y-o,right:t.x+n,bottom:t.y+o}}isPointVisible(e,t,n,o=0){let s=this.getVisibleBounds(e);return t>=s.left-o&&t<=s.right+o&&n>=s.top-o&&n<=s.bottom+o}};var X={},tn=null,nn=new Set;function Jt(){return tn?.world?._isSimulating??!1}function en(i,e){nn.has(i)||(nn.add(i),console.warn(e))}function on(i){if(tn){console.warn("Determinism guard already installed for another game instance");return}tn=i,nn.clear(),X.mathRandom=Math.random,Math.random=function(){return Jt()&&en("Math.random",`\u26A0\uFE0F Math.random() is non-deterministic!
   Use dRandom() instead for deterministic random numbers.
   Example: const r = dRandom();`),X.mathRandom()},X.mathSqrt=Math.sqrt,Math.sqrt=function(e){return Jt()&&en("Math.sqrt",`\u26A0\uFE0F Math.sqrt() is non-deterministic!
   Use dSqrt() instead for deterministic square root.
   Example: const dist = dSqrt(dx * dx + dy * dy);`),X.mathSqrt(e)},X.dateNow=Date.now,Date.now=function(){return Jt()&&en("Date.now",`\u26A0\uFE0F Date.now() is non-deterministic!
   Use game.time instead for deterministic timing.
   Example: const respawnAt = game.time + 3000;`),X.dateNow()},typeof performance<"u"&&(X.performanceNow=performance.now.bind(performance),performance.now=function(){return Jt()&&en("performance.now",`\u26A0\uFE0F performance.now() is non-deterministic!
   Use game.time instead for deterministic timing.`),X.performanceNow()}),console.log("\u{1F6E1}\uFE0F Determinism guard enabled")}function Ai(){X.mathRandom&&(Math.random=X.mathRandom),X.mathSqrt&&(Math.sqrt=X.mathSqrt),X.dateNow&&(Date.now=X.dateNow),X.performanceNow&&typeof performance<"u"&&(performance.now=X.performanceNow),tn=null,nn.clear(),Object.keys(X).forEach(i=>{delete X[i]})}var Pi="f5de42b";var le=null,Yo=null,Mi=null,Ni=null;var Vn=0,_i=0,kn=0;function Vi(i,e={}){if(le)return le;Ni=i||null,i&&"world"in i&&on(i);let t=e.position||"top-right";le=document.createElement("div"),le.id="modu-debug-ui",le.style.cssText=`
        position: fixed;
        ${t.includes("top")?"top: 10px":"bottom: 10px"};
        ${t.includes("right")?"right: 10px":"left: 10px"};
        background: rgba(0, 0, 0, 0.8);
        color: #0f0;
        font: 12px monospace;
        padding: 8px 12px;
        border-radius: 4px;
        z-index: 10000;
        min-width: 180px;
        user-select: text;
        cursor: text;
        
    `,document.body.appendChild(le);let n=s=>{if(!le)return;Vn++,s-kn>=1e3&&(_i=Vn,Vn=0,kn=s);let r=Ni;if(!r){le.innerHTML='<div style="color:#f00">No engine instance</div>';return}let c=r.getClientId(),l=r.getFrame(),a=r.getNodeUrl(),d=r.getLastSnapshot(),p=r.getServerFps(),h=r.getRoomId(),f=r.getUploadRate(),y=r.getDownloadRate(),m=r.getClients(),x="--------";try{if(Mi){let k=Mi();x=typeof k=="number"?k.toString(16).padStart(8,"0"):String(k).slice(0,8)}else x=r.getStateHash().toString(16).padStart(8,"0")}catch{x="error"}let v=k=>k>=1024?(k/1024).toFixed(1)+" kB/s":Math.round(k)+" B/s",E=v(f),F=v(y),b=r.getDeltaBandwidth?.()||0,D=r.getSyncStats?.()||{syncPercent:100,passed:0,failed:0,isDesynced:!1,resyncPending:!1},M=D.passed+D.failed,A;if(D.resyncPending)A='<span style="color:#f80">resyncing...</span>';else if(D.isDesynced)A='<span style="color:#f00">DESYNCED</span>';else if(M>0){let k=(Math.floor(D.syncPercent*10)/10).toFixed(1);A=`<span style="color:${D.syncPercent===100?"#0f0":D.syncPercent>=99?"#ff0":"#f00"}">${k}%</span> <span style="color:#888">(${M} checks)</span>`}else b>0?A='<span style="color:#0f0">active</span>':A='<span style="color:#888">-</span>';let N=d.frame?l-d.frame:0,q=d.hash!==null?d.hash.toString(16).padStart(8,"0"):null,U=q?`${q} <span style="color:#888">(${N} ago)</span>`:"none",Q=k=>k>=1024*1024?(k/(1024*1024)).toFixed(2)+" MB":k>=1024?(k/1024).toFixed(1)+" KB":k+" B",T=d.size>0?Q(d.size):"-",P=r.getEntityCount?.()||0,Y=P>0?String(P):"-",W="color:#666;font-size:10px;margin-top:6px;margin-bottom:2px;border-bottom:1px solid #333;",ae=v(b);le.innerHTML=`
            <div style="${W}">ROOM</div>
            <div>ID: <span style="color:#fff">${h||"-"}</span></div>
            <div>Players: <span style="color:#ff0">${m.length}</span></div>
            <div>Frame: <span style="color:#fff">${l}</span></div>

            <div style="${W}">CLIENT</div>
            <div>ID: <span style="color:#ff0">${c?c.slice(0,8):"-"}</span></div>

            <div style="${W}">ENGINE</div>
            <div>Commit: <span style="color:#888">${Pi}</span></div>
            <div>FPS: <span style="color:#0f0">${_i}</span> render, <span style="color:#0f0">${p}</span> tick</div>
            <div>Net: <span style="color:#0f0">${E}</span> up, <span style="color:#f80">${F}</span> down</div>

            <div style="${W}">STATE SYNC</div>
            <div>Hash: <span style="color:#f0f">${x}</span></div>
            <div>Delta: <span style="color:#0ff">${ae}</span></div>
            <div>Sync: ${A}</div>
            <div>Entities: <span style="color:#fff">${Y}</span></div>
        `},o=s=>{n(s),Yo=requestAnimationFrame(o)};return kn=performance.now(),requestAnimationFrame(o),le}var On={};Dt(On,{BodyType2D:()=>$e,DEFAULT_FILTER:()=>cn,Layers:()=>Ue,QuadTree2D:()=>Sn,Shape2DType:()=>Pe,SpatialHash2D:()=>Ge,TriggerState:()=>vn,aabb2DArea:()=>Li,aabb2DOverlap:()=>sn,aabb2DUnion:()=>ki,addBody2D:()=>gn,applyForce2D:()=>Wi,applyImpulse2D:()=>Hn,computeAABB2D:()=>Me,createBody2D:()=>We,createBox2D:()=>zi,createBox2DFromSize:()=>an,createCircle:()=>rn,createFilter:()=>Hi,createWorld2D:()=>yn,detectCollision2D:()=>fn,filterCollidingWith:()=>Yi,filterExcluding:()=>Oi,getBody2DIdCounter:()=>xt,loadWorldState2D:()=>Qi,makeTrigger:()=>Ji,removeBody2D:()=>je,resetBody2DIdCounter:()=>hn,resolveCollision2D:()=>mn,saveWorldState2D:()=>Zi,setBody2DIdCounter:()=>St,setBody2DMass:()=>$i,setBody2DVelocity:()=>Xi,shouldCollide:()=>ln,stepWorld2D:()=>vt,vec2:()=>dn,vec2Add:()=>Xe,vec2Clone:()=>qi,vec2Cross:()=>zn,vec2Dot:()=>Ui,vec2LengthSq:()=>pn,vec2Scale:()=>Fe,vec2Sub:()=>Ln,vec2Zero:()=>gt});var Pe=(t=>(t[t.Circle=0]="Circle",t[t.Box=1]="Box",t))(Pe||{});function sn(i,e){return i.minX<=e.maxX&&i.maxX>=e.minX&&i.minY<=e.maxY&&i.maxY>=e.minY}function ki(i,e){return{minX:ie(i.minX,e.minX),minY:ie(i.minY,e.minY),maxX:de(i.maxX,e.maxX),maxY:de(i.maxY,e.maxY)}}function Li(i){let e=i.maxX-i.minX,t=i.maxY-i.minY;return u(e,t)}function rn(i){return{type:0,radius:g(i)}}function zi(i,e){return{type:1,halfWidth:g(i),halfHeight:g(e)}}function an(i,e){let t=g(i)>>1,n=g(e)>>1;return{type:1,halfWidth:t,halfHeight:n}}var Ue={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},cn={layer:Ue.DEFAULT,mask:Ue.ALL};function Hi(i,e=Ue.ALL){return{layer:i,mask:e}}function ln(i,e){return(i.mask&e.layer)!==0&&(e.mask&i.layer)!==0}function Yi(i,...e){let t=0;for(let n of e)t|=n;return{layer:i,mask:t}}function Oi(i,...e){let t=Ue.ALL;for(let n of e)t&=~n;return{layer:i,mask:t}}var Oo=g(0),qo=g(.5),Uo=5461,$e=(n=>(n[n.Static=0]="Static",n[n.Kinematic=1]="Kinematic",n[n.Dynamic=2]="Dynamic",n))($e||{});function gt(){return{x:0,y:0}}function dn(i,e){return{x:g(i),y:g(e)}}function qi(i){return{x:i.x,y:i.y}}function Xe(i,e){return{x:i.x+e.x,y:i.y+e.y}}function Ln(i,e){return{x:i.x-e.x,y:i.y-e.y}}function Fe(i,e){return{x:u(i.x,e),y:u(i.y,e)}}function Ui(i,e){return u(i.x,e.x)+u(i.y,e.y)}function pn(i){return u(i.x,i.x)+u(i.y,i.y)}function zn(i,e){return u(i.x,e.y)-u(i.y,e.x)}var un=1;function hn(){un=1}function xt(){return un}function St(i){un=i}function We(i,e,t,n,o){let s=i===2?g(1):0,r=i===2?65536:0,c=0;if(i===2)if(e.type===0){let d=e.radius;c=u(u(s,32768),u(d,d))}else{let d=e.halfWidth<<1,p=e.halfHeight<<1;c=u(u(s,Uo),u(d,d)+u(p,p))}let l=un++,a=o||"body2d_"+l;return{id:l,type:i,shape:e,label:a,position:dn(t,n),angle:0,linearVelocity:gt(),angularVelocity:0,mass:s,invMass:r,inertia:c||65536,invInertia:c?C(65536,c):0,restitution:Oo,friction:qo,isSleeping:!1,sleepFrames:0,lockRotation:!1,isSensor:!1,isBullet:!1,filter:{...cn},userData:null}}function $i(i,e){i.type===2&&(i.mass=g(e),i.invMass=e>0?C(65536,i.mass):0)}function Xi(i,e,t){i.linearVelocity=dn(e,t),i.isSleeping=!1}function Hn(i,e,t){if(!(i.type!==2||i.invMass===0)){if(i.linearVelocity=Xe(i.linearVelocity,Fe(e,i.invMass)),t&&!i.lockRotation){let n=Ln(t,i.position),o=zn(n,e);i.angularVelocity=i.angularVelocity+u(o,i.invInertia)}i.isSleeping=!1}}function Wi(i,e,t){if(i.type!==2||i.invMass===0)return;let n=Fe(e,t);Hn(i,n)}function Me(i){let{position:e,shape:t,angle:n}=i;if(t.type===0){let o=t.radius;return{minX:e.x-o,minY:e.y-o,maxX:e.x+o,maxY:e.y+o}}else{let o=t,s=o.halfWidth,r=o.halfHeight;if(n===0)return{minX:e.x-s,minY:e.y-r,maxX:e.x+s,maxY:e.y+r};let c=Ie(n),l=ge(n),a=I(c),d=I(l),p=u(s,a)+u(r,d),h=u(s,d)+u(r,a);return{minX:e.x-p,minY:e.y-h,maxX:e.x+p,maxY:e.y+h}}}function fn(i,e){let t=i.shape,n=e.shape;if(t.type===0&&n.type===0)return $o(i,e);if(t.type===1&&n.type===1)return Xo(i,e);if(t.type===0&&n.type===1)return Gi(i,e);if(t.type===1&&n.type===0){let o=Gi(e,i);return o?{bodyA:i,bodyB:e,point:o.point,normal:{x:-o.normal.x,y:-o.normal.y},depth:o.depth}:null}return null}function $o(i,e){let t=i.shape.radius,n=e.shape.radius,o=t+n,s=e.position.x-i.position.x,r=e.position.y-i.position.y,c=u(s,s)+u(r,r),l=u(o,o);if(c>=l)return null;let a=_(c),d=o-a,p,h;if(a>0){let m=C(65536,a);p=u(s,m),h=u(r,m)}else p=65536,h=0;let f=i.position.x+u(p,t),y=i.position.y+u(h,t);return{bodyA:i,bodyB:e,point:{x:f,y},normal:{x:p,y:h},depth:d}}function Xo(i,e){let t=i.shape,n=e.shape,o=e.position.x-i.position.x,s=e.position.y-i.position.y,r=t.halfWidth+n.halfWidth-I(o),c=t.halfHeight+n.halfHeight-I(s);if(r<=0||c<=0)return null;let l,a,d;r<c?(d=r,l=o>0?65536:-65536,a=0):(d=c,l=0,a=s>0?65536:-65536);let p=i.position.x+e.position.x>>1,h=i.position.y+e.position.y>>1;return{bodyA:i,bodyB:e,point:{x:p,y:h},normal:{x:l,y:a},depth:d}}function Gi(i,e){let t=i.shape.radius,n=e.shape,o=i.position.x-e.position.x,s=i.position.y-e.position.y,r=de(-n.halfWidth,ie(n.halfWidth,o)),c=de(-n.halfHeight,ie(n.halfHeight,s)),l=I(o)<n.halfWidth&&I(s)<n.halfHeight,a,d,p;if(l){let y=n.halfWidth-o,m=n.halfWidth+o,x=n.halfHeight-s,v=n.halfHeight+s,E=y;a=65536,d=0,m<E&&(E=m,a=-65536,d=0),x<E&&(E=x,a=0,d=65536),v<E&&(E=v,a=0,d=-65536),p=E+t}else{let y=o-r,m=s-c,x=u(y,y)+u(m,m);if(x>=u(t,t))return null;let v=_(x);if(p=t-v,v>0){let E=C(65536,v);a=u(-y,E),d=u(-m,E)}else a=65536,d=0}let h=i.position.x+u(a,t),f=i.position.y+u(d,t);return{bodyA:i,bodyB:e,point:{x:h,y:f},normal:{x:a,y:d},depth:p}}function mn(i){let{bodyA:e,bodyB:t,normal:n,depth:o}=i;if(e.isSensor||t.isSensor)return;let s=e.type,r=t.type;s===0&&r===0||(Wo(e,t,n,o),(s===2||r===2)&&Go(e,t,n))}function Wo(i,e,t,n){let o=i.type,s=e.type,r=o!==0,c=s!==0;if(!r&&!c)return;let l=g(.01),a=de(0,n-l);if(!(a<=0))if(r&&c){let d=a>>1;i.position.x=i.position.x-u(t.x,d),i.position.y=i.position.y-u(t.y,d),e.position.x=e.position.x+u(t.x,d),e.position.y=e.position.y+u(t.y,d)}else r?(i.position.x=i.position.x-u(t.x,a),i.position.y=i.position.y-u(t.y,a)):(e.position.x=e.position.x+u(t.x,a),e.position.y=e.position.y+u(t.y,a))}function Go(i,e,t){let n=i.type===2?i.invMass:0,o=e.type===2?e.invMass:0,s=n+o;if(s===0)return;let r=e.linearVelocity.x-i.linearVelocity.x,c=e.linearVelocity.y-i.linearVelocity.y,l=u(r,t.x)+u(c,t.y);if(l>0)return;let a=ie(i.restitution,e.restitution),d=C(u(-(65536+a),l),s),p=u(t.x,d),h=u(t.y,d);i.type===2&&(i.linearVelocity.x=i.linearVelocity.x-u(p,n),i.linearVelocity.y=i.linearVelocity.y-u(h,n)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+u(p,o),e.linearVelocity.y=e.linearVelocity.y+u(h,o)),jo(i,e,t,d,n,o,s)}function jo(i,e,t,n,o,s,r){let c=e.linearVelocity.x-i.linearVelocity.x,l=e.linearVelocity.y-i.linearVelocity.y,a=u(c,t.x)+u(l,t.y),d=c-u(t.x,a),p=l-u(t.y,a),h=u(d,d)+u(p,p);if(h===0)return;let f=_(h),y=C(65536,f),m=u(d,y),x=u(p,y),v=u(i.friction,e.friction),E=u(c,m)+u(l,x),F=C(-E,r),b=u(v,I(n));I(F)>b&&(F=F>0?b:-b);let D=u(m,F),M=u(x,F);i.type===2&&(i.linearVelocity.x=i.linearVelocity.x-u(D,o),i.linearVelocity.y=i.linearVelocity.y-u(M,o)),e.type===2&&(e.linearVelocity.x=e.linearVelocity.x+u(D,s),e.linearVelocity.y=e.linearVelocity.y+u(M,s))}function Ko(i){if(i.shape.type===0)return w(i.shape.radius);{let e=i.shape,t=w(e.halfWidth),n=w(e.halfHeight);return wt(t*t+n*n)}}var Ge=class{constructor(e=64){this.cells=new Map;this.bodyToCell=new Map;this.oversized=[];this.allRegular=[];this.cellSize=e,this.invCellSize=1/e}hashPosition(e,t){let n=Math.floor(e*this.invCellSize)&65535,o=Math.floor(t*this.invCellSize)&65535;return n<<16|o}clear(){this.cells.clear(),this.bodyToCell.clear(),this.oversized.length=0,this.allRegular.length=0}insert(e){if(Ko(e)*2>this.cellSize){this.oversized.push(e);return}this.allRegular.push(e);let o=w(e.position.x),s=w(e.position.y),r=this.hashPosition(o,s),c=this.cells.get(r);c||(c=[],this.cells.set(r,c)),c.push(e),this.bodyToCell.set(e,r)}insertAll(e){for(let t of e)this.insert(t)}queryPoint(e,t){let n=this.hashPosition(e,t);return this.cells.get(n)||[]}queryNearby(e){let t=w(e.position.x),n=w(e.position.y),o=Math.floor(t*this.invCellSize),s=Math.floor(n*this.invCellSize),r=[];for(let c=-1;c<=1;c++)for(let l=-1;l<=1;l++){let a=o+c&65535,d=s+l&65535,p=a<<16|d,h=this.cells.get(p);if(h)for(let f of h)f!==e&&r.push(f)}return r}queryRadius(e,t,n){let o=Math.ceil(n*this.invCellSize),s=Math.floor(e*this.invCellSize),r=Math.floor(t*this.invCellSize),c=[],l=new Set;for(let a=-o;a<=o;a++)for(let d=-o;d<=o;d++){let p=s+a&65535,h=r+d&65535,f=p<<16|h,y=this.cells.get(f);if(y)for(let m of y)l.has(m)||(l.add(m),c.push(m))}return c}forEachPair(e){for(let[o,s]of this.cells){for(let p=0;p<s.length;p++)for(let h=p+1;h<s.length;h++)e(s[p],s[h]);let r=o>>16&65535,c=o&65535,l=[(r+1&65535)<<16|c,r<<16|c+1&65535,(r+1&65535)<<16|c+1&65535];for(let p of l){if(p<=o)continue;let h=this.cells.get(p);if(h)for(let f of s)for(let y of h)e(f,y)}let a=(r-1&65535)<<16|c+1&65535,d=this.cells.get(a);if(d)for(let p of s)for(let h of d)e(p,h)}let t=this.oversized,n=this.allRegular;for(let o=0;o<t.length;o++)for(let s=o+1;s<t.length;s++)e(t[o],t[s]);for(let o of t)for(let s of n)e(o,s)}getPotentialPairs(){let e=[];return this.forEachPair((t,n)=>e.push([t,n])),e}getStats(){let e=0,t=0;for(let n of this.cells.values())e=Math.max(e,n.length),t+=n.length;return{cellCount:this.cells.size,maxPerCell:e,avgPerCell:this.cells.size>0?t/this.cells.size:0,oversizedCount:this.oversized.length}}};var ji={x:0,y:g(-30)},Zo=g(.1),Qo=g(.1),Ki=g(.12),Jo=20,es=64;function yn(i=1/60){let e={bodies:[],gravity:{x:ji.x,y:ji.y},dt:g(i),step(){vt(e)}};return e}function gn(i,e){i.bodies.push(e)}function je(i,e){let t=i.bodies.indexOf(e);t>=0&&i.bodies.splice(t,1)}function vt(i){let{gravity:e,dt:t}=i,n=[],o=[],s=[],r=[...i.bodies].sort((a,d)=>{let p=parseInt(a.label,10)||0,h=parseInt(d.label,10)||0;return p-h});for(let a of r){if(a.type!==2||a.isSleeping)continue;a.linearVelocity=Xe(a.linearVelocity,Fe(e,t));let d=65536-Zo,p=65536-Qo;a.linearVelocity=Fe(a.linearVelocity,d),a.angularVelocity=u(a.angularVelocity,p)}let c=new Ge(es);c.insertAll(r);let l=[];c.forEachPair((a,d)=>{if(a.type===0&&d.type===0||!ln(a.filter,d.filter))return;let p=Me(a),h=Me(d);if(!sn(p,h))return;let f=fn(a,d);if(!f)return;let y=parseInt(a.label,10)||0,m=parseInt(d.label,10)||0,x=y>m,v=a.userData,E=d.userData;if((v||E)&&s.push({entityA:x?E:v,entityB:x?v:E,labelA:x?d.label:a.label,labelB:x?a.label:d.label}),a.isSensor||d.isSensor){a.isSensor&&o.push({trigger:a,other:d}),d.isSensor&&o.push({trigger:d,other:a});return}let F=x?d.label:a.label,b=x?a.label:d.label;l.push({contact:f,labelA:F,labelB:b}),n.push(f)}),l.sort((a,d)=>{let p=parseInt(a.labelA,10)||0,h=parseInt(d.labelA,10)||0,f=p-h;if(f!==0)return f;let y=parseInt(a.labelB,10)||0,m=parseInt(d.labelB,10)||0;return y-m});for(let{contact:a}of l)mn(a);s.sort((a,d)=>{let p=parseInt(a.labelA,10)||0,h=parseInt(d.labelA,10)||0,f=p-h;if(f!==0)return f;let y=parseInt(a.labelB,10)||0,m=parseInt(d.labelB,10)||0;return y-m});for(let a of s)a.entityA?.active===!1||a.entityB?.active===!1||i.physics2d?.handleCollision?.(a.entityA,a.entityB)||(a.entityA?.onCollision&&a.entityA.onCollision(a.entityB),a.entityB?.onCollision&&a.entityB.onCollision(a.entityA));for(let a of r){if(a.type===0||a.isSleeping)continue;let d=g(.05),p=g(.01);I(a.linearVelocity.x)<d&&(a.linearVelocity.x=0),I(a.linearVelocity.y)<d&&(a.linearVelocity.y=0),I(a.angularVelocity)<p&&(a.angularVelocity=0),a.position=Xe(a.position,Fe(a.linearVelocity,t)),!a.lockRotation&&a.angularVelocity!==0&&(a.angle=a.angle+u(a.angularVelocity,t));let h=pn(a.linearVelocity),f=u(a.angularVelocity,a.angularVelocity),y=u(Ki,Ki);h<y&&f<y?(a.sleepFrames++,a.sleepFrames>=Jo&&(a.isSleeping=!0,a.linearVelocity=gt(),a.angularVelocity=0)):(a.sleepFrames=0,a.isSleeping=!1)}return{contacts:n,triggers:o}}function ts(i){if(i.type===0)return{type:0,radius:i.radius};{let e=i;return{type:1,halfWidth:e.halfWidth,halfHeight:e.halfHeight}}}function ns(i){return i.type===0?{type:0,radius:i.radius}:{type:1,halfWidth:i.halfWidth,halfHeight:i.halfHeight}}function is(i){return{id:i.id,label:i.label,bodyType:i.type,shape:ts(i.shape),px:i.position.x,py:i.position.y,angle:i.angle,vx:i.linearVelocity.x,vy:i.linearVelocity.y,av:i.angularVelocity,mass:i.mass,restitution:i.restitution,friction:i.friction,isSleeping:i.isSleeping,sleepFrames:i.sleepFrames,lockRotation:i.lockRotation,isSensor:i.isSensor,isBullet:i.isBullet,filter:{...i.filter},userData:i.userData}}function Zi(i){return{bodies:i.bodies.map(is)}}function os(i){let e=ns(i.shape),t=xt(),n=We(i.bodyType,e,0,0,i.label);if(n.id=i.id,St(t),n.position={x:i.px,y:i.py},n.angle=i.angle,n.linearVelocity={x:i.vx,y:i.vy},n.angularVelocity=i.av,n.mass=i.mass,n.invMass=i.mass>0?C(65536,i.mass):0,i.bodyType===2&&i.mass>0){if(e.type===0){let o=e.radius;n.inertia=u(u(i.mass,32768),u(o,o))}else{let o=e,s=o.halfWidth<<1,r=o.halfHeight<<1,c=5461;n.inertia=u(u(i.mass,c),u(s,s)+u(r,r))}n.invInertia=n.inertia>0?C(65536,n.inertia):0}return n.restitution=i.restitution,n.friction=i.friction,n.isSleeping=i.isSleeping,n.sleepFrames=i.sleepFrames,n.lockRotation=i.lockRotation,n.isSensor=i.isSensor,n.isBullet=i.isBullet??!1,n.filter={...i.filter},n.userData=i.userData,n}function Qi(i,e){let t=[...e.bodies].sort((c,l)=>{let a=parseInt(c.label,10)||0,d=parseInt(l.label,10)||0;return a-d}),n=new Set(t.map(c=>c.label));for(let c=i.bodies.length-1;c>=0;c--)n.has(i.bodies[c].label)||i.bodies.splice(c,1);let o=new Map(i.bodies.map(c=>[c.label,c])),s=0;for(let c of t){c.id>s&&(s=c.id);let l=o.get(c.label);if(l)l.position={x:c.px,y:c.py},l.angle=c.angle,l.linearVelocity={x:c.vx,y:c.vy},l.angularVelocity=c.av,l.isSleeping=c.isSleeping,l.sleepFrames=c.sleepFrames,l.lockRotation=c.lockRotation,l.isSensor=c.isSensor,l.restitution=c.restitution,l.friction=c.friction,l.filter={...c.filter},c.userData!==void 0&&(l.userData=c.userData);else{let a=os(c);i.bodies.push(a)}}let r=xt();s>=r&&St(s+1),i.bodies.sort((c,l)=>{let a=parseInt(c.label,10)||0,d=parseInt(l.label,10)||0;return a-d})}var ss=8,rs=8;function as(i,e){return i.minX<=e.maxX&&i.maxX>=e.minX&&i.minY<=e.maxY&&i.maxY>=e.minY}function xn(i){let e=Me(i);return{minX:w(e.minX),minY:w(e.minY),maxX:w(e.maxX),maxY:w(e.maxY)}}var Yn=class i{constructor(e,t,n,o){this.entities=[];this.children=null;this.bounds=e,this.depth=t,this.maxEntities=n,this.maxDepth=o}insert(e,t){if(this.children){let n=this.getChildIndex(t);if(n!==-1){this.children[n].insert(e,t);return}this.entities.push(e);return}this.entities.push(e),this.entities.length>this.maxEntities&&this.depth<this.maxDepth&&this.subdivide()}subdivide(){let{minX:e,minY:t,maxX:n,maxY:o}=this.bounds,s=(e+n)/2,r=(t+o)/2;this.children=[new i({minX:e,minY:t,maxX:s,maxY:r},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:s,minY:t,maxX:n,maxY:r},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:e,minY:r,maxX:s,maxY:o},this.depth+1,this.maxEntities,this.maxDepth),new i({minX:s,minY:r,maxX:n,maxY:o},this.depth+1,this.maxEntities,this.maxDepth)];let c=this.entities;this.entities=[];for(let l of c){let a=xn(l),d=this.getChildIndex(a);d!==-1?this.children[d].insert(l,a):this.entities.push(l)}}getChildIndex(e){let{minX:t,minY:n,maxX:o,maxY:s}=this.bounds,r=(t+o)/2,c=(n+s)/2,l=e.maxY<=c,a=e.minY>=c,d=e.maxX<=r,p=e.minX>=r;return l&&d?0:l&&p?1:a&&d?2:a&&p?3:-1}query(e,t){for(let n of this.entities)t.push(n);if(this.children)for(let n of this.children)as(n.bounds,e)&&n.query(e,t)}forEachPairIterative(e){let t=[],n=[];for(t.push({node:this,ancestorStart:0});t.length>0;){let{node:o,ancestorStart:s}=t.pop();n.length=s;let r=o.entities;for(let l=0;l<r.length;l++)for(let a=l+1;a<r.length;a++)e(r[l],r[a]);for(let l=0;l<s;l++)for(let a of r)e(n[l],a);let c=n.length;for(let l of r)n.push(l);if(o.children)for(let l=3;l>=0;l--)t.push({node:o.children[l],ancestorStart:n.length})}}forEachPair(e,t=[]){this.forEachPairIterative(e)}getStats(){let e=1,t=this.depth,n=this.entities.length;if(this.children)for(let o of this.children){let s=o.getStats();e+=s.nodeCount,t=Math.max(t,s.maxDepth),n+=s.entityCount}return{nodeCount:e,maxDepth:t,entityCount:n}}},Sn=class{constructor(e=ss,t=rs){this.root=null;this.maxEntities=e,this.maxDepth=t}clear(){this.root=null}insertAll(e){if(e.length===0)return;let t=1/0,n=1/0,o=-1/0,s=-1/0;for(let c of e){let l=xn(c);t=Math.min(t,l.minX),n=Math.min(n,l.minY),o=Math.max(o,l.maxX),s=Math.max(s,l.maxY)}let r=1;this.root=new Yn({minX:t-r,minY:n-r,maxX:o+r,maxY:s+r},0,this.maxEntities,this.maxDepth);for(let c of e){let l=xn(c);this.root.insert(c,l)}}queryNearby(e){if(!this.root)return[];let t=[],n=xn(e);return this.root.query(n,t),t.filter(o=>o!==e)}forEachPair(e){this.root&&this.root.forEachPair(e)}getStats(){return this.root?this.root.getStats():{nodeCount:0,maxDepth:0,entityCount:0}}};var vn=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,n=[...e].sort((s,r)=>{let c=parseInt(s.trigger.label,10)||0,l=parseInt(r.trigger.label,10)||0,a=c-l;if(a!==0)return a;let d=parseInt(s.other.label,10)||0,p=parseInt(r.other.label,10)||0;return d-p});for(let s of n){let r=this.makeKey(s.trigger,s.other);if(t.add(r),this.overlaps.has(r))for(let c of this.stayCallbacks)c(s);else{this.overlaps.set(r,s);for(let c of this.enterCallbacks)c(s)}}let o=[...this.overlaps.keys()].sort();for(let s of o)if(!t.has(s)){let r=this.overlaps.get(s);this.overlaps.delete(s);for(let c of this.exitCallbacks)c(r)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[n,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(n);t.sort();for(let n of t){let o=this.overlaps.get(n);this.overlaps.delete(n);for(let s of this.exitCallbacks)s(o)}}getOverlappingBodies(e){let t=[];for(let n of this.overlaps.values())n.trigger===e&&t.push(n.other);return t.sort((n,o)=>{let s=parseInt(n.label,10)||0,r=parseInt(o.label,10)||0;return s-r})}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,n)=>{let o=parseInt(t[0],10)||0,s=parseInt(n[0],10)||0,r=o-s;if(r!==0)return r;let c=parseInt(t[1],10)||0,l=parseInt(n[1],10)||0;return c-l})}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let n of e)t.set(n.label,n);for(let[n,o]of this.pendingPairs){let s=t.get(n),r=t.get(o);s&&r&&this.overlaps.set(this.makeKey(s,r),{trigger:s,other:r})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function Ji(i){return i.isSensor=!0,i}var bt=class{constructor(e,t){this.world=null;this.entityToBody=new Map;this.bodyToEntity=new Map;this.collisionHandlers=new Map;this.pendingEntities=new Set;let n,o=null;e&&"world"in e?(o=e,n=t??{}):n=e??{},this.physicsWorld=yn(n.dt??1/60),n.gravity&&(this.physicsWorld.gravity={x:g(n.gravity.x),y:g(n.gravity.y)});let s=this;this.physicsWorld.contactListener={onContact(r,c){s.handleCollision(r,c)}},this.physicsWorld.physics2d={handleCollision:(r,c)=>this.handleCollisionByType(r,c)},o&&(this.attach(o.world),o.physics=this)}attach(e){return this.world=e,e.addSystem(()=>this.syncBodiesToPhysics(),{phase:"prePhysics",order:0}),e.addSystem(()=>this.step(),{phase:"physics",order:0}),e.addSystem(()=>this.syncPhysicsToComponents(),{phase:"postPhysics",order:0}),this}onCollision(e,t,n){let o=`${e}:${t}`,s=`${t}:${e}`;return this.collisionHandlers.set(o,n),e!==t&&this.collisionHandlers.set(s,(r,c)=>n(c,r)),this}setGravity(e,t){return this.physicsWorld.gravity={x:g(e),y:g(t)},this}ensureBody(e){let t=e.eid,n=this.entityToBody.get(t);if(n)return n;if(!e.has(O)||!e.has($))return null;let o=e.get(O),s=e.get($),r;switch(s.bodyType){case st:r=0;break;case rt:r=1;break;default:r=2}let c;return s.shapeType===ze||s.radius>0?c=rn(s.radius||10):c=an(s.width||10,s.height||10),n=We(r,c,o.x,o.y),n.angle=g(o.angle),n.linearVelocity={x:g(s.vx),y:g(s.vy)},n.angularVelocity=g(s.angularVelocity),n.isSensor=s.isSensor,n.isSleeping=!1,n.sleepFrames=0,n.userData=e,n.label=t.toString(),gn(this.physicsWorld,n),this.entityToBody.set(t,n),this.bodyToEntity.set(n.id,t),n}removeBody(e){let t=e.eid,n=this.entityToBody.get(t);n&&(je(this.physicsWorld,n),this.entityToBody.delete(t),this.bodyToEntity.delete(n.id))}syncBodiesToPhysics(){if(this.world){for(let e of this.world.query($)){let t=this.ensureBody(e);if(!t)continue;let n=e.get($);if(n.bodyType===rt||n.bodyType===st){let r=e.get(O);t.position.x=g(r.x),t.position.y=g(r.y),t.angle=g(r.angle)}if((n.impulseX!==0||n.impulseY!==0)&&(n.vx+=n.impulseX,n.vy+=n.impulseY,n.impulseX=0,n.impulseY=0),(n.forceX!==0||n.forceY!==0)&&(n.vx+=n.forceX,n.vy+=n.forceY,n.forceX=0,n.forceY=0),n.damping>0){let r=1-n.damping;n.vx*=r,n.vy*=r}let o=g(n.vx),s=g(n.vy);if(t.linearVelocity.x=o,t.linearVelocity.y=s,t.angularVelocity=g(n.angularVelocity),(o!==0||s!==0)&&(t.isSleeping=!1,t.sleepFrames=0),t.shape.type===0){let r=t.shape.radius,c=g(n.radius);r!==c&&(t.shape.radius=c)}}for(let[e,t]of this.entityToBody)this.world.isDestroyed(e)&&(je(this.physicsWorld,t),this.entityToBody.delete(e),this.bodyToEntity.delete(t.id))}}step(){vt(this.physicsWorld)}syncPhysicsToComponents(){for(let[e,t]of this.entityToBody){let n=this.world?.getEntity(e);if(!n||n.destroyed)continue;let o=n.get(O),s=n.get($);o.x=w(t.position.x),o.y=w(t.position.y),o.angle=w(t.angle),s.vx=w(t.linearVelocity.x),s.vy=w(t.linearVelocity.y),s.angularVelocity=w(t.angularVelocity)}}handleCollision(e,t){let n=e.userData,o=t.userData;!n||!o||n.destroyed||o.destroyed||this.handleCollisionByType(n,o)}handleCollisionByType(e,t){if(!e||!t||e.destroyed||t.destroyed)return!1;let n=`${e.type}:${t.type}`,o=this.collisionHandlers.get(n);return o?(o(e,t),e.type===t.type&&!e.destroyed&&!t.destroyed&&o(t,e),!0):!1}getBody(e){return this.entityToBody.get(e.eid)}getEntityForBody(e){let t=this.bodyToEntity.get(e.id);return t===void 0?null:this.world?.getEntity(t)??null}clear(){let e=this.entityToBody.size;for(let t of this.entityToBody.values())je(this.physicsWorld,t);this.entityToBody.clear(),this.bodyToEntity.clear(),hn(),console.log(`[PHYSICS-CLEAR] Cleared ${e} bodies`)}wakeAllBodies(){for(let e of this.physicsWorld.bodies)e.isSleeping=!1,e.sleepFrames=0}syncAllFromComponents(){if(!this.world)return;let e=[...this.world.query($)].sort((o,s)=>o.eid-s.eid),t=this.entityToBody.size;if(this.entityToBody.size===0&&e.length>0){console.log(`[PHYSICS-SYNC] Creating ${e.length} bodies from scratch`);for(let o of e)this.ensureBody(o)}let n=0;for(let[o,s]of this.entityToBody){let r=this.world.getEntity(o);if(!r||r.destroyed)continue;let c=r.get(O),l=r.get($);n<3&&console.log(`[PHYSICS-SYNC] Body ${o}: pos(${c.x.toFixed(1)},${c.y.toFixed(1)}) -> physics`),s.position.x=g(c.x),s.position.y=g(c.y),s.angle=g(c.angle),s.linearVelocity.x=g(l.vx),s.linearVelocity.y=g(l.vy),s.angularVelocity=g(l.angularVelocity),s.isSleeping=!1,s.sleepFrames=0,n++}console.log(`[PHYSICS-SYNC] Synced ${n} bodies (existed before: ${t})`)}};function eo(i={}){return new bt(i)}var Un={};Dt(Un,{BodyType:()=>Fn,DEFAULT_FILTER:()=>bn,Layers:()=>Ze,ShapeType:()=>Ke,TriggerState:()=>Qe,aabbOverlap:()=>Ft,addBody:()=>xo,applyForce:()=>ho,applyImpulse:()=>Ce,computeAABB:()=>Ne,createBody:()=>lo,createBox:()=>to,createFilter:()=>io,createSphere:()=>no,createWorld:()=>go,detectCollision:()=>_e,filterCollidingWith:()=>oo,filterExcluding:()=>so,getBodyIdCounter:()=>ao,isGrounded:()=>vo,loadWorldState:()=>Co,makeTrigger:()=>yo,raycast:()=>bo,removeBody:()=>So,resetBodyIdCounter:()=>ro,resolveCollision:()=>En,saveWorldState:()=>Fo,setBodyIdCounter:()=>co,setBodyMass:()=>po,setBodyVelocity:()=>uo,shouldCollide:()=>Ct,stepWorld:()=>qn});var Ke=(t=>(t[t.Box=0]="Box",t[t.Sphere=1]="Sphere",t))(Ke||{});function to(i,e,t){return{type:0,halfExtents:De(i,e,t)}}function no(i){return{type:1,radius:g(i)}}function Ft(i,e){return i.max.x>=e.min.x&&i.min.x<=e.max.x&&i.max.y>=e.min.y&&i.min.y<=e.max.y&&i.max.z>=e.min.z&&i.min.z<=e.max.z}var Ze={NONE:0,DEFAULT:1,PLAYER:2,ENEMY:4,PROJECTILE:8,ITEM:16,TRIGGER:32,WORLD:64,PROP:128,CUSTOM_1:256,CUSTOM_2:512,CUSTOM_3:1024,CUSTOM_4:2048,CUSTOM_5:4096,CUSTOM_6:8192,CUSTOM_7:16384,CUSTOM_8:32768,ALL:65535},bn={layer:Ze.DEFAULT,mask:Ze.ALL};function io(i,e=Ze.ALL){return{layer:i,mask:e}}function Ct(i,e){return(i.mask&e.layer)!==0&&(e.mask&i.layer)!==0}function oo(i,...e){let t=0;for(let n of e)t|=n;return{layer:i,mask:t}}function so(i,...e){let t=Ze.ALL;for(let n of e)t&=~n;return{layer:i,mask:t}}var cs=g(0),ls=g(.5),Fn=(n=>(n[n.Static=0]="Static",n[n.Kinematic=1]="Kinematic",n[n.Dynamic=2]="Dynamic",n))(Fn||{}),Et=1;function ro(){Et=1}function ao(){return Et}function co(i){Et=i}function lo(i,e,t,n,o,s){let r=i===2?g(1):0,c=i===2?65536:0,l=0;if(i===2)if(e.type===0){let p=e.halfExtents;l=u(r,u(g(1/6),u(p.x,p.x)+u(p.y,p.y)+u(p.z,p.z)))}else{let p=e.radius;l=u(r,u(g(.4),u(p,p)))}let a=s||"body_"+Et;return{id:Et++,label:a,type:i,shape:e,position:De(t,n,o),rotation:tt(),linearVelocity:pe(),angularVelocity:pe(),mass:r,invMass:c,inertia:l||65536,invInertia:l?C(65536,l):0,restitution:cs,friction:ls,isSleeping:!1,sleepFrames:0,lockRotationX:!1,lockRotationY:!1,lockRotationZ:!1,isTrigger:!1,filter:{...bn},userData:null}}function po(i,e){i.type===2&&(i.mass=g(e),i.invMass=e>0?C(65536,i.mass):0)}function uo(i,e,t,n){i.linearVelocity=De(e,t,n),i.isSleeping=!1}function Ce(i,e,t){if(!(i.type!==2||i.invMass===0)){if(i.linearVelocity=z(i.linearVelocity,R(e,i.invMass)),t){let n=L(t,i.position),o=K(n,e);i.angularVelocity=z(i.angularVelocity,R(o,i.invInertia))}i.isSleeping=!1}}function ho(i,e,t){if(i.type!==2||i.invMass===0)return;let n=R(e,t);Ce(i,n)}var fo=g(.6),Cn=g(.05),ds=g(1.5);function Ne(i){let e=i.position,t=i.shape;if(t.type===1){let n=t.radius;return{min:{x:e.x-n,y:e.y-n,z:e.z-n},max:{x:e.x+n,y:e.y+n,z:e.z+n}}}else{let n=t.halfExtents,o=j(i.rotation,V(65536,0,0)),s=j(i.rotation,V(0,65536,0)),r=j(i.rotation,V(0,0,65536)),c=I(u(o.x,n.x))+I(u(s.x,n.y))+I(u(r.x,n.z)),l=I(u(o.y,n.x))+I(u(s.y,n.y))+I(u(r.y,n.z)),a=I(u(o.z,n.x))+I(u(s.z,n.y))+I(u(r.z,n.z));return{min:{x:e.x-c,y:e.y-l,z:e.z-a},max:{x:e.x+c,y:e.y+l,z:e.z+a}}}}function ps(i,e){let t=i.shape,n=e.shape,o=L(i.position,e.position),s=G(o),r=t.radius+n.radius,c=u(r,r);if(s>=c)return null;let l=_(s),a=l>0?R(o,C(65536,l)):V(65536,0,0),d=r-l,p=L(i.position,R(a,t.radius));return{bodyA:i,bodyB:e,normal:a,points:[{point:p,penetration:d}]}}function mo(i,e){let t=i.shape,n=e.shape,o=L(i.position,e.position),s=kt(e.rotation),r=j(s,o),c=n.halfExtents,l={x:ke(r.x,-c.x,c.x),y:ke(r.y,-c.y,c.y),z:ke(r.z,-c.z,c.z)},a=L(r,l),d=G(a),p=u(t.radius,t.radius);if(d>=p)return null;let h=_(d),f,y;if(h>0)f=R(a,C(65536,h)),y=t.radius-h;else{let v=c.x-I(r.x),E=c.y-I(r.y),F=c.z-I(r.z);v<=E&&v<=F?(f=r.x>=0?V(65536,0,0):V(-65536,0,0),y=v+t.radius):E<=F?(f=r.y>=0?V(0,65536,0):V(0,-65536,0),y=E+t.radius):(f=r.z>=0?V(0,0,65536):V(0,0,-65536),y=F+t.radius)}let m=z(e.position,j(e.rotation,l)),x=j(e.rotation,f);return{bodyA:i,bodyB:e,normal:x,points:[{point:m,penetration:y}]}}function us(i,e){let t=i.shape,n=e.shape,o=t.halfExtents,s=n.halfExtents,r=[j(i.rotation,V(65536,0,0)),j(i.rotation,V(0,65536,0)),j(i.rotation,V(0,0,65536))],c=[j(e.rotation,V(65536,0,0)),j(e.rotation,V(0,65536,0)),j(e.rotation,V(0,0,65536))],l=[o.x,o.y,o.z],a=[s.x,s.y,s.z],d=L(e.position,i.position),p=2147483647,h=V(0,65536,0);function f(T,P,Y){return I(u(H(T[0],Y),P[0]))+I(u(H(T[1],Y),P[1]))+I(u(H(T[2],Y),P[2]))}function y(T){let P=G(T);if(P<g(1e-4))return!0;let Y=_(P),W=R(T,C(65536,Y)),ae=f(r,l,W),k=f(c,a,W),Ve=I(H(d,W)),Ee=ae+k-Ve;return Ee<=0?!1:(Ee<p&&(p=Ee,h=H(d,W)<0?W:xe(W)),!0)}for(let T=0;T<3;T++)if(!y(r[T])||!y(c[T]))return null;for(let T=0;T<3;T++)for(let P=0;P<3;P++)if(!y(K(r[T],c[P])))return null;let m=[],x=u(u(o.x,o.y),o.z),v=u(u(s.x,s.y),s.z),E=v<=x?e:i,F=v<=x?s:o,b=v<=x?i:e,D=[[-1,-1,-1],[-1,-1,1],[-1,1,-1],[-1,1,1],[1,-1,-1],[1,-1,1],[1,1,-1],[1,1,1]],M=v<=x?h:xe(h),A=[],N=v<=x?r:c,q=v<=x?o:s;for(let[T,P,Y]of D){let W=V(u(F.x,g(T)),u(F.y,g(P)),u(F.z,g(Y))),ae=z(E.position,j(E.rotation,W)),k=L(ae,b.position),Ve=H(k,M),Ee=u(I(H(N[0],M)),q.x)+u(I(H(N[1],M)),q.y)+u(I(H(N[2],M)),q.z),It=Ve+Ee;It>0&&A.push({point:ae,depth:It})}A.sort((T,P)=>{let Y=P.depth-T.depth;return Y!==0?Y:T.point.x-P.point.x||T.point.y-P.point.y||T.point.z-P.point.z});let U=g(.05),Q=A.length>0?A[0].depth:0;for(let T of A)if(T.depth>Q-U&&m.push({point:T.point,penetration:T.depth}),m.length>=4)break;if(m.length===0){let T=R(z(i.position,e.position),32768);m.push({point:T,penetration:p})}return{bodyA:i,bodyB:e,normal:h,points:m}}function _e(i,e){let t=i.shape.type,n=e.shape.type;if(t===1&&n===1)return ps(i,e);if(t===1&&n===0)return mo(i,e);if(t===0&&n===1){let o=mo(e,i);return o?{bodyA:i,bodyB:e,normal:xe(o.normal),points:o.points}:null}else return us(i,e)}function En(i){let{bodyA:e,bodyB:t,normal:n,points:o}=i;if(e.invMass===0&&t.invMass===0||o.length===0)return;let s=L(e.linearVelocity,t.linearVelocity);if(I(H(s,n))<ds&&(e.isSleeping||t.isSleeping)){for(let h of o){let f=h.penetration;if(f>Cn){let y=e.invMass+t.invMass;if(y>0){let m=u(C(f-Cn,y),fo),x=R(n,m);e.invMass>0&&!e.isSleeping&&(e.position=z(e.position,R(x,e.invMass))),t.invMass>0&&!t.isSleeping&&(t.position=L(t.position,R(x,t.invMass)))}}}return}let l=o.length,a=C(65536,g(l)),d=ie(e.restitution,t.restitution),p=C(e.friction+t.friction,g(2));for(let h of o){let f=h.point,y=h.penetration,m=L(f,e.position),x=L(f,t.position),v=z(e.linearVelocity,K(e.angularVelocity,m)),E=z(t.linearVelocity,K(t.angularVelocity,x)),F=L(v,E),b=H(F,n);if(b<0){let D=K(m,n),M=K(x,n),A=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:u(H(D,D),e.invInertia),N=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:u(H(M,M),t.invInertia),q=e.invMass+t.invMass+A+N,U=u(-(65536+d),b);U=C(U,q),U=u(U,a);let Q=R(n,U);e.invMass>0&&Ce(e,Q,f),t.invMass>0&&Ce(t,xe(Q),f);let T=L(F,R(n,b)),P=G(T);if(P>g(1e-4)){let Y=ue(T),W=K(m,Y),ae=K(x,Y),k=e.lockRotationX&&e.lockRotationY&&e.lockRotationZ?0:u(H(W,W),e.invInertia),Ve=t.lockRotationX&&t.lockRotationY&&t.lockRotationZ?0:u(H(ae,ae),t.invInertia),Ee=e.invMass+t.invMass+k+Ve,It=_(P),et=C(It,Ee);et=u(et,a);let $n=u(I(U),p);et>$n&&(et=$n);let Xn=R(Y,-et);e.invMass>0&&Ce(e,Xn,f),t.invMass>0&&Ce(t,xe(Xn),f)}}if(y>Cn){let D=e.invMass+t.invMass,M=u(C(y-Cn,D),fo),A=u(M,a),N=R(n,A);e.invMass>0&&(e.position=z(e.position,R(N,e.invMass))),t.invMass>0&&(t.position=L(t.position,R(N,t.invMass)))}}}var Qe=class{constructor(){this.overlaps=new Map;this.enterCallbacks=[];this.stayCallbacks=[];this.exitCallbacks=[];this.pendingPairs=[]}onEnter(e){this.enterCallbacks.push(e)}onStay(e){this.stayCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}processOverlaps(e){let t=new Set,n=[...e].sort((s,r)=>this.makeKey(s.trigger,s.other).localeCompare(this.makeKey(r.trigger,r.other)));for(let s of n){let r=this.makeKey(s.trigger,s.other);if(t.add(r),this.overlaps.has(r))for(let c of this.stayCallbacks)c(s);else{this.overlaps.set(r,s);for(let c of this.enterCallbacks)c(s)}}let o=[...this.overlaps.keys()].sort();for(let s of o)if(!t.has(s)){let r=this.overlaps.get(s);this.overlaps.delete(s);for(let c of this.exitCallbacks)c(r)}}clear(){this.overlaps.clear()}removeBody(e){let t=[];for(let[n,o]of this.overlaps)(o.trigger===e||o.other===e)&&t.push(n);t.sort();for(let n of t){let o=this.overlaps.get(n);this.overlaps.delete(n);for(let s of this.exitCallbacks)s(o)}}getOverlappingBodies(e){let t=[];for(let n of this.overlaps.values())n.trigger===e&&t.push(n.other);return t.sort((n,o)=>n.label.localeCompare(o.label))}isBodyInTrigger(e,t){return this.overlaps.has(this.makeKey(e,t))}overlapCount(){return this.overlaps.size}saveState(){let e=[];for(let t of this.overlaps.values())e.push([t.trigger.label,t.other.label]);return e.sort((t,n)=>t[0].localeCompare(n[0])||t[1].localeCompare(n[1]))}loadState(e){this.overlaps.clear(),this.pendingPairs=e}syncWithWorld(e){let t=new Map;for(let n of e)t.set(n.label,n);for(let[n,o]of this.pendingPairs){let s=t.get(n),r=t.get(o);s&&r&&this.overlaps.set(this.makeKey(s,r),{trigger:s,other:r})}this.pendingPairs=[]}makeKey(e,t){return`${e.label}:${t.label}`}};function yo(i){return i.isTrigger=!0,i}var hs={x:0,y:g(-30),z:0},fs=g(.1),ms=g(.1),Je=g(.12),ys=20,gs=10,xs=8;function go(i=1/60){let e={bodies:[],gravity:Pt(hs),dt:g(i),triggers:new Qe,step(){return qn(e)}};return e}function xo(i,e){i.bodies.push(e)}function So(i,e){let t=i.bodies.indexOf(e);t>=0&&(i.bodies.splice(t,1),i.triggers.removeBody(e))}function vo(i,e,t=.15){let n=g(t);for(let o of i.bodies){if(o===e)continue;let s=_e(e,o);if(s&&s.normal.y>32768)return!0;let r=e.position.y;e.position.y=e.position.y-n;let c=_e(e,o);if(e.position.y=r,c&&c.normal.y>32768)return!0}return!1}function qn(i){let{gravity:e,dt:t,triggers:n}=i,o=[],s=[],r=[...i.bodies].sort((a,d)=>a.label.localeCompare(d.label)),c=new Set,l=new Set;for(let a=0;a<r.length;a++)for(let d=a+1;d<r.length;d++){let p=r[a],h=r[d];if(p.invMass===0&&h.invMass===0||!Ct(p.filter,h.filter))continue;let f=Ne(p),y=Ne(h);if(!Ft(f,y))continue;let m=_e(p,h);m&&I(m.normal.y)>32768&&(c.add(p),c.add(h),p.isSleeping&&h.type===2&&G(h.linearVelocity)+G(h.angularVelocity)<u(Je,Je)&&l.add(h),h.isSleeping&&p.type===2&&G(p.linearVelocity)+G(p.angularVelocity)<u(Je,Je)&&l.add(p))}for(let a of r){if(a.type!==2||a.isSleeping)continue;a.linearVelocity=z(a.linearVelocity,R(e,t));let d=65536-fs,p=65536-ms;c.has(a)&&(d=u(d,g(.95)),p=u(p,g(.9))),a.linearVelocity=R(a.linearVelocity,d),a.angularVelocity=R(a.angularVelocity,p)}for(let a=0;a<xs;a++)for(let d=0;d<r.length;d++)for(let p=d+1;p<r.length;p++){let h=r[d],f=r[p];if(h.invMass===0&&f.invMass===0||!Ct(h.filter,f.filter))continue;let y=Ne(h),m=Ne(f);if(!Ft(y,m))continue;let x=_e(h,f);x&&(h.isTrigger||f.isTrigger?a===0&&(h.isTrigger&&s.push({trigger:h,other:f}),f.isTrigger&&s.push({trigger:f,other:h})):(a===0&&o.push(x),En(x)))}n.processOverlaps(s);for(let a of r){if(a.type===0||a.isSleeping)continue;let d=g(.05);if(I(a.linearVelocity.x)<d&&(a.linearVelocity.x=0),I(a.linearVelocity.y)<d&&(a.linearVelocity.y=0),I(a.linearVelocity.z)<d&&(a.linearVelocity.z=0),a.position=z(a.position,R(a.linearVelocity,t)),a.lockRotationX&&a.lockRotationY&&a.lockRotationZ)continue;let p=a.lockRotationX?0:a.angularVelocity.x,h=a.lockRotationY?0:a.angularVelocity.y,f=a.lockRotationZ?0:a.angularVelocity.z,y=g(.01);I(p)<y&&(p=0),I(h)<y&&(h=0),I(f)<y&&(f=0),a.angularVelocity.x=p,a.angularVelocity.y=h,a.angularVelocity.z=f;let m=u(p,p)+u(h,h)+u(f,f);if(m>0){let F=_(m),b=u(F,t),D=C(65536,F),M={x:u(p,D),y:u(h,D),z:u(f,D)},A=Nt(M,b);a.rotation=Vt(_t(A,a.rotation))}let x=G(a.linearVelocity),v=G(a.angularVelocity),E=u(Je,Je);if(x<E&&v<E){let F=l.has(a)?1+gs:1;a.sleepFrames+=F,a.sleepFrames>=ys&&(a.isSleeping=!0,a.linearVelocity=pe(),a.angularVelocity=pe())}else a.sleepFrames=0,a.isSleeping=!1}return o}function bo(i,e,t,n){let o=ue(t),s=null,r=n;for(let c of i.bodies){let l=Ss(c,e,o,r);l&&l.distance<r&&(r=l.distance,s=l)}return s}function Ss(i,e,t,n){return i.shape.type===1?vs(i,e,t,n):bs(i,e,t,n)}function vs(i,e,t,n){let o=i.shape,s=L(e,i.position),r=H(t,t),c=u(g(2),H(s,t)),l=H(s,s)-u(o.radius,o.radius),a=u(c,c)-u(u(g(4),r),l);if(a<0)return null;let d=_(a),p=C(-c-d,u(g(2),r));if(p<0&&(p=C(-c+d,u(g(2),r)),p<0)||p>n)return null;let h=z(e,R(t,p)),f=ue(L(h,i.position));return{body:i,point:h,normal:f,distance:p}}function bs(i,e,t,n){let s=i.shape.halfExtents,r=i.position,c=-2147483647,l=2147483647,a=0,d=1;{let f=t.x!==0?C(65536,t.x):2147483647,y=u(r.x-s.x-e.x,f),m=u(r.x+s.x-e.x,f);if(f<0&&([y,m]=[m,y]),y>c&&(c=y,a=0,d=f<0?1:-1),m<l&&(l=m),l<c)return null}{let f=t.y!==0?C(65536,t.y):2147483647,y=u(r.y-s.y-e.y,f),m=u(r.y+s.y-e.y,f);if(f<0&&([y,m]=[m,y]),y>c&&(c=y,a=1,d=f<0?1:-1),m<l&&(l=m),l<c)return null}{let f=t.z!==0?C(65536,t.z):2147483647,y=u(r.z-s.z-e.z,f),m=u(r.z+s.z-e.z,f);if(f<0&&([y,m]=[m,y]),y>c&&(c=y,a=2,d=f<0?1:-1),m<l&&(l=m),l<c)return null}if(c<0||c>n)return null;let p=z(e,R(t,c)),h=V(a===0?g(d):0,a===1?g(d):0,a===2?g(d):0);return{body:i,point:p,normal:h,distance:c}}function Fo(i){return{bodies:i.bodies.map(e=>({id:e.id,label:e.label,px:e.position.x,py:e.position.y,pz:e.position.z,qx:e.rotation.x,qy:e.rotation.y,qz:e.rotation.z,qw:e.rotation.w,vx:e.linearVelocity.x,vy:e.linearVelocity.y,vz:e.linearVelocity.z,avx:e.angularVelocity.x,avy:e.angularVelocity.y,avz:e.angularVelocity.z,isSleeping:e.isSleeping,sleepFrames:e.sleepFrames}))}}function Co(i,e){let t=new Set(e.bodies.map(o=>o.label));for(let o=i.bodies.length-1;o>=0;o--)t.has(i.bodies[o].label)||i.bodies.splice(o,1);let n=new Map(i.bodies.map(o=>[o.label,o]));for(let o of e.bodies){let s=n.get(o.label);s&&(s.position={x:o.px,y:o.py,z:o.pz},s.rotation={x:o.qx,y:o.qy,z:o.qz,w:o.qw},s.linearVelocity={x:o.vx,y:o.vy,z:o.vz},s.angularVelocity={x:o.avx,y:o.avy,z:o.avz},s.isSleeping=o.isSleeping,s.sleepFrames=o.sleepFrames)}}return wo(Fs);})();
